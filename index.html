<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Impala RBE Monitor - Platinum Operations</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css' rel='stylesheet' />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>

  <style>
    :root {
      --bg:#0a0e17; --card:#1a2332; --txt:#e2e8f0; --border:#334155; --hdr:#1e293b;
      --prim:#0d47a1; --prim-light:#1976d2; --succ:#2ecc71; --warn:#f39c12;
      --danger:#e74c3c; --maint:#3498db; --high:#e74c3c; --pred:#e67e22;
      --shadow:0 8px 32px rgba(0,0,0,0.5); --radius:12px; --gap:20px; --pad:20px;
      --accent-gold:#f4c542; --teal:#008080;
    }
    [data-theme="light"] {
      --bg:#f8fafc; --card:#ffffff; --txt:#1e293b; --border:#cbd5e1; --hdr:#f1f5f9;
      --shadow:0 4px 16px rgba(0,0,0,0.1);
    }
    *,*::before,*::after { box-sizing:border-box; margin:0; padding:0; }
    html,body { height:100%; font-family:'Roboto',sans-serif; background:var(--bg); color:var(--txt); }

    body {
      background-image:url('https://images.unsplash.com/photo-1565538810648-7f5a2c106b8f?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80');
      background-size:cover; background-position:center; background-attachment:fixed;
    }

    h1,h2,h3,h4 { margin:0 0 .6em; color:var(--prim); font-weight:700; }
    h1 { font-size: clamp(1.9rem, 5.5vw, 2.6rem); }
    h2 { font-size: clamp(1.5rem, 4.5vw, 2rem); }

    .wrapper { display:flex; min-height:100vh; }

    .sidebar {
      position: fixed;
      top:0; left:0; bottom:0;
      width: 280px;
      background:var(--prim); color:#fff;
      padding:var(--pad);
      z-index: 1000;
      transform: translateX(-100%);
      transition: transform 0.4s ease;
      overflow-y:auto;
    }
    .sidebar.open { transform: translateX(0); }

    .sidebar-header {
      display:flex; justify-content:space-between; align-items:center; margin-bottom:2.2rem;
    }
    .logo-img { max-width:160px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.5); }

    #sidebar-menu { list-style:none; }
    #sidebar-menu li {
      padding:16px 20px; margin:10px 0; border-radius:10px; cursor:pointer;
      transition:all .35s; font-weight:600; display:flex; align-items:center; gap:16px;
    }
    #sidebar-menu li[data-icon]::before { content:attr(data-icon); font-size:1.5rem; }
    #sidebar-menu li:hover,
    #sidebar-menu li.active { background:var(--prim-light); transform:translateX(6px); }

    .hamburger {
      position:fixed; top:16px; left:16px; z-index:1100;
      background:rgba(13,71,161,0.9); color:white; border:none;
      width:52px; height:52px; border-radius:50%; font-size:1.8rem;
      cursor:pointer; display:flex; align-items:center; justify-content:center;
      box-shadow:0 4px 14px rgba(0,0,0,0.5);
    }

    .main {
      flex:1; padding:var(--gap); padding-top:80px; overflow-y:auto;
    }
    .container {
      max-width:1700px; margin:0 auto;
      background:var(--card); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:var(--pad);
      backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,.1);
    }

    .header-bar {
      background:linear-gradient(135deg,var(--prim),var(--prim-light));
      color:#fff; padding:1.2rem 1.6rem; border-radius:var(--radius) var(--radius) 0 0;
      margin:-var(--pad) -var(--pad) var(--gap);
      display:flex; flex-wrap:wrap; gap:16px; justify-content:space-between; align-items:center;
    }

    .kpi-grid {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:var(--gap); margin:1.8rem 0;
    }
    .kpi-card {
      padding:1.6rem; border-radius:var(--radius); text-align:center; color:#fff;
      box-shadow:var(--shadow); position:relative; overflow:hidden;
    }
    .kpi-card::before {
      content:''; position:absolute; top:0; left:0; width:100%; height:5px;
      background:linear-gradient(90deg,var(--accent-gold),transparent);
    }
    .kpi-card.green::before { background:var(--succ); }
    .kpi-card.orange::before { background:var(--warn); }
    .kpi-card.red::before { background:var(--danger); }
    .kpi-card h2 { font-size:clamp(2.1rem,7vw,3rem); margin:0; }
    .kpi-card p { font-size:1rem; opacity:.92; }

    .chart-wrapper { background:var(--card); padding:1.6rem; border-radius:var(--radius); box-shadow:var(--shadow); margin:1.8rem 0; border:1px solid rgba(255,255,255,.15); }
    .chart-title { font-weight:700; color:var(--prim); margin-bottom:1rem; font-size:1.2rem; }
    .chart-container { height:320px; position:relative; }

    .alert-banner {
      padding:1.3rem; border-radius:var(--radius); margin:1.6rem 0; box-shadow:var(--shadow);
      border-left:6px solid; backdrop-filter:blur(6px); display:flex; flex-direction:column; gap:10px;
    }
    .alert-high-risk { background:rgba(231,76,60,.16); border-color:var(--high); color:var(--high); }
    .alert-predictive { background:rgba(230,126,34,.16); border-color:var(--pred); color:var(--pred); }
    .alert-list { list-style:none; margin:1rem 0 0; flex:1; }
    .alert-item { background:rgba(255,255,255,.15); padding:1rem; margin:8px 0; border-radius:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid rgba(255,255,255,.12); }
    .risk-badge { padding:7px 18px; border-radius:30px; font-size:.8rem; font-weight:900; color:#fff; }
    .risk-high { background:var(--high); }
    .risk-predict { background:var(--pred); }

    table {
      width:100%; border-collapse:collapse; margin:1.6rem 0; font-size:.97rem;
    }
    th,td { padding:14px 12px; text-align:left; border-bottom:1px solid var(--border); }
    th { background:var(--teal); color:#fff; font-weight:700; position:sticky; top:0; z-index:2; }
    tr:nth-child(even) { background:rgba(255,255,255,.03); }
    tr:hover { background:rgba(13,71,161,.1); }

    .form-group { margin:1.3rem 0; }
    label { display:block; font-weight:600; margin-bottom:.5rem; color:var(--prim); }
    input,select,textarea {
      width:100%; padding:14px 16px; border:1px solid var(--border);
      border-radius:10px; background:var(--card); color:var(--txt); font-size:1rem;
    }
    button {
      padding:14px 28px; border:none; border-radius:10px; cursor:pointer;
      font-weight:600; font-size:1rem; transition:all .3s;
    }
    button:hover { transform:translateY(-2px); }

    button.primary  { background:linear-gradient(135deg,var(--prim),var(--prim-light)); color:#fff; }
    button.success  { background:var(--succ); color:#fff; }
    button.warn     { background:var(--warn); color:#000; }
    button.danger   { background:var(--danger); color:#fff; }
    button.maint    { background:var(--maint); color:#fff; }

    .modal {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.65);
      backdrop-filter:blur(5px); align-items:center; justify-content:center; z-index:2000;
    }
    .modal.active { display:flex; }
    .modal-content {
      background:var(--card); padding:1.8rem; border-radius:var(--radius);
      width:92%; max-width:520px; max-height:90vh; overflow-y:auto;
    }

    .live-indicator {
      position:fixed; bottom:16px; right:16px; background:var(--succ); color:#fff;
      padding:10px 20px; border-radius:50px; font-weight:700; box-shadow:var(--shadow);
      z-index:999; font-size:0.92rem;
    }

    .hidden { display:none !important; }

    @media (min-width: 1025px) {
      .sidebar { transform:translateX(0); position:sticky; top:0; height:100vh; }
      .hamburger { display:none; }
      .main { padding-top:var(--gap); }
    }

    @media (max-width: 768px) {
      .kpi-grid { grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); }
      .header-bar { flex-direction:column; align-items:stretch; }
    }

    @media (max-width: 480px) {
      .kpi-grid { grid-template-columns:1fr; }
      button { width:100%; margin:10px 0; padding:16px; font-size:1.05rem; }
      .chart-container { height:240px; }
    }
  </style>
</head>
<body data-theme="dark">

<button class="hamburger" onclick="document.getElementById('sidebar').classList.toggle('open')">â˜°</button>

<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <img class="logo-img" src="https://apventures.com/wp-content/uploads/2023/06/image-35.jpeg" alt="Impala Platinum Logo">
    <button onclick="document.getElementById('sidebar').classList.remove('open')" style="background:none;border:none;color:white;font-size:2rem;cursor:pointer;">Ã—</button>
  </div>
  <ul id="sidebar-menu">
    <li class="active" data-section="dashboard" data-icon="ðŸ“Š"><span>Dashboard</span></li>
    <li data-section="add-equipment" data-icon="ðŸš‚"><span>+ Equipment</span></li>
    <li data-section="add-status" data-icon="ðŸ”„"><span>Status Update</span></li>
    <li data-section="search-status" data-icon="ðŸ”"><span>Search</span></li>
    <li data-section="status-log" data-icon="ðŸ“œ"><span>Full Log</span></li>
    <li data-section="summary" data-icon="ðŸ“ˆ"><span>Analytics</span></li>
    <li data-section="manage-equipment" data-icon="âš™ï¸"><span>Equipment List</span></li>
    <li data-section="maintenance-schedule" data-icon="ðŸ› "><span>Maintenance</span></li>
    <li data-section="calendar" data-icon="ðŸ“…"><span>Calendar</span></li>
    <li data-section="operations-report" data-icon="ðŸ“œ"><span>Ops Report</span></li>
  </ul>
</div>

<div class="main">
  <div class="container">

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section id="dashboard">
      <div class="header-bar">
        <h1>REAL-TIME PLATINUM OPERATIONS</h1>
        <div style="display:flex;gap:14px;align-items:center;flex-wrap:wrap;">
          <select id="shaft-filter" onchange="filterDashboard()"></select>
          <button class="primary" onclick="exportDashboardPDF()">Export Dashboard (PDF)</button>
        </div>
      </div>

      <div id="high-risk-alerts" class="alert-banner alert-high-risk hidden">
        <strong>HIGH RISK EQUIPMENT</strong>
        <ul id="high-risk-list" class="alert-list"></ul>
      </div>

      <div id="predictive-alerts" class="alert-banner alert-predictive hidden">
        <strong>PREDICTIVE MAINTENANCE</strong>
        <ul id="predictive-list" class="alert-list"></ul>
      </div>

      <div class="kpi-grid" id="kpi-grid"></div>

      <div class="chart-wrapper">
        <div class="chart-title">Equipment Availability (%)</div>
        <div class="chart-container"><canvas id="availabilityChart"></canvas></div>
      </div>

      <div class="chart-wrapper">
        <div class="chart-title">Failure Count by Equipment</div>
        <div class="chart-container"><canvas id="failuresChart"></canvas></div>
      </div>

      <div class="chart-wrapper">
        <div class="chart-title">MTTF (Mean Time To Failure) - Days</div>
        <div class="chart-container"><canvas id="mttfChart"></canvas></div>
      </div>

      <div class="chart-wrapper">
        <div class="chart-title">Delay Reasons (This Week)</div>
        <div class="chart-container"><canvas id="delayChart"></canvas></div>
      </div>

      <div id="upcoming-maintenance" style="padding:1.6rem;background:linear-gradient(135deg,rgba(227,242,253,.2),rgba(187,222,251,.2));border-radius:var(--radius);border-left:6px solid var(--maint);margin-top:1.8rem;">
        <h3 style="color:var(--maint);margin-bottom:1rem;">Upcoming Maintenance Schedule</h3>
        <div id="maintenance-list"></div>
      </div>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ADD EQUIPMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section id="add-equipment" class="hidden">
      <div class="header-bar"><h1>Add New Equipment</h1></div>
      <form id="add-eq-form" style="max-width:600px;margin:0 auto;">
        <div class="form-group"><label>Shaft</label><select id="shaft" required></select></div>
        <div class="form-group"><label>Level</label><input id="level" type="text" required></div>
        <div class="form-group"><label>Loco Size</label><input id="loco-size" type="text" required></div>
        <div class="form-group"><label>Loco Number</label><input id="loco-number" type="text" required pattern="[0-9]+" title="Numbers only"></div>
        <div class="form-group"><label>SECTION</label><input id="section" type="text" required></div>
        <button type="submit" class="primary" style="width:100%;margin-top:1rem;">Add Equipment</button>
      </form>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STATUS UPDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section id="add-status" class="hidden">
      <div class="header-bar"><h1>Status Update</h1></div>
      <form id="add-status-form" style="max-width:600px;margin:0 auto;">
        <div class="form-group"><label>Date</label><input id="u-date" type="date" required></div>
        <div class="form-group"><label>Time</label><input id="u-time" type="time" required></div>
        <div class="form-group"><label>Equipment ID</label><input id="u-loco" list="loco-list" required></div>
        <div class="form-group"><label>Status</label><select id="u-status"><option>Fixed</option><option>Down</option></select></div>
        <div class="form-group"><label>Shift</label><select id="u-shift"><option>Morning</option><option>Afternoon</option><option>Night</option></select></div>
        <div class="form-group"><label>Reason/Fault</label><textarea id="u-reason" required rows="3"></textarea></div>
        <div class="form-group"><label>Downtime Hours</label><input id="u-downtime" type="number" step="0.1" min="0"></div>
        <div class="form-group"><label>Is Failure?</label><select id="u-failure"><option value="0">No</option><option value="1">Yes</option></select></div>
        <button type="submit" class="primary" style="width:100%;margin-top:1rem;">Submit Update</button>
      </form>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section id="search-status" class="hidden">
      <div class="header-bar"><h1>Search Status</h1></div>
      <form id="search-form" style="max-width:800px;margin:0 auto;">
        <div class="form-group"><label>Equipment ID</label><input id="s-loco" list="loco-list"></div>
        <div class="form-group"><label>Date (optional)</label><input id="s-date" type="date"></div>
        <div style="margin:1rem 0;display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="show-all-history">
          <label for="show-all-history" style="margin:0;font-weight:600;">Show Full History</label>
        </div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;">
          <button type="submit" class="primary">Search</button>
          <button type="button" class="maint" onclick="generateJobPDF()">Job Order PDF</button>
        </div>
      </form>
      <div id="search-results" style="margin-top:2rem;"></div>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FULL LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section id="status-log" class="hidden">
      <div class="header-bar">
        <h1>Full Status Log</h1>
        <button class="primary" onclick="exportLogCSV()">Export Log (CSV)</button>
      </div>
      <div style="overflow-x:auto;">
        <table id="log-table">
          <thead><tr><th>Date</th><th>Time</th><th>ID</th><th>Status</th><th>Shift</th><th>Fault</th><th>Down Hrs</th><th>Failure</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ANALYTICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section id="summary" class="hidden">
      <div class="header-bar">
        <h1>Fleet Analytics</h1>
      </div>
      <div style="overflow-x:auto;">
        <table id="summary-table">
          <thead><tr><th>ID</th><th>Updates</th><th>Total Days</th><th>Down Days</th><th>Op Days</th><th>Failures</th><th>MTTF</th><th>Avail %</th><th>Last Update</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ EQUIPMENT LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section id="manage-equipment" class="hidden">
      <div class="header-bar"><h1>Equipment List</h1></div>
      <div style="overflow-x:auto;">
        <table id="equipment-table">
          <thead><tr><th>Shaft</th><th>Level</th><th>Loco Size</th><th>Loco Number</th><th>SECTION</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MAINTENANCE SCHEDULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section id="maintenance-schedule" class="hidden">
      <div class="header-bar">
        <h1>Maintenance Schedule</h1>
        <div style="display:flex;gap:12px;flex-wrap:wrap;">
          <button class="primary" onclick="document.getElementById('add-maint-modal').classList.add('active')">+ Add Task</button>
        </div>
      </div>
      <div style="overflow-x:auto;">
        <table id="maint-table">
          <thead><tr><th>Equipment</th><th>Task</th><th>Interval</th><th>Last Done</th><th>Due</th><th>Days Left</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section id="calendar" class="hidden">
      <div class="header-bar"><h1>Maintenance Calendar</h1></div>
      <div id="calendar-div" style="background:var(--card);padding:2rem;border-radius:var(--radius);box-shadow:var(--shadow);min-height:600px;border:1px solid rgba(255,255,255,.15);"></div>
    </section>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ OPERATIONS REPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <section id="operations-report" class="hidden">
      <div class="header-bar">
        <h1>All Operations Report</h1>
      </div>
      <!-- Dynamic content filled in JS -->
      <h2 style="color:var(--teal);">Operation Status Summary</h2>
      <div style="overflow-x:auto;">
        <table id="op-status-table">
          <thead><tr><th>Status</th><th>Count</th><th>Percentage</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

  </div>
</div>

<div class="live-indicator">LIVE SYNC â€¢ 0.3s</div>

<datalist id="loco-list"></datalist>

<!-- MODALS -->
<div id="add-maint-modal" class="modal">
  <div class="modal-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem;">
      <h3>Add Maintenance Task</h3>
      <button onclick="document.getElementById('add-maint-modal').classList.remove('active')" style="background:none;border:none;font-size:1.6rem;cursor:pointer;color:var(--txt);">Ã—</button>
    </div>
    <form id="add-maint-form">
      <div class="form-group"><label>Equipment</label><input list="loco-list" required></div>
      <div class="form-group"><label>Task</label><input type="text" required></div>
      <div class="form-group"><label>Interval</label>
        <select required><option>weekly</option><option>monthly</option><option>quarterly</option></select>
      </div>
      <div class="form-group"><label>Last Done</label><input type="date" required></div>
      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:1.5rem;">
        <button type="button" class="warn" onclick="document.getElementById('add-maint-modal').classList.remove('active')">Cancel</button>
        <button type="submit" class="primary">Add Task</button>
      </div>
    </form>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  GLOBAL DATA & HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let equipment = [], updates = [], maintenance = [], charts = {}, calendar = null;

const STORAGE_KEYS = {
  equipment: 'rbe_equipment',
  updates:   'rbe_updates',
  maintenance:'rbe_maintenance'
};

function loadData() {
  equipment   = JSON.parse(localStorage.getItem(STORAGE_KEYS.equipment))   || [];
  updates     = JSON.parse(localStorage.getItem(STORAGE_KEYS.updates))     || [];
  maintenance = JSON.parse(localStorage.getItem(STORAGE_KEYS.maintenance)) || [];
}

function saveData(key, data) {
  localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(data));
}

const SHAFTS = [
  '1 Shaft','2 Shaft','5 Shaft','6 Shaft','7 Shaft','7A Shaft','8 Shaft','9 Shaft','10 Shaft',
  '11 Shaft','11C Shaft','12 Shaft','12 North Shaft','14 Shaft','16 Shaft','17 Shaft','20 Shaft',
  'CLAPHAM','DRIKOP','E&F Shaft','NORTH SHAFT','SOUTH SHAFT','STYLDRIFT','Winnaarshoek',
  'Forest Hill','Offset Underground','UG2 Main','Transport','Concentrator'
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DATE & CALCULATION HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function daysBetween(d1, d2) {
  return Math.floor(Math.abs(new Date(d2) - new Date(d1)) / 86400000);
}

function calculateNextDue(lastDone, interval) {
  if (!lastDone) return null;
  const d = new Date(lastDone);
  if (interval === 'weekly')    d.setDate(d.getDate() + 7);
  if (interval === 'monthly')   d.setMonth(d.getMonth() + 1);
  if (interval === 'quarterly') d.setMonth(d.getMonth() + 3);
  return d.toISOString().split('T')[0];
}

function calculateDaysLeft(lastDone, interval) {
  const next = calculateNextDue(lastDone, interval);
  if (!next) return NaN;
  return Math.floor((new Date(next) - new Date()) / 86400000);
}

function getLatestUpdateFor(id) {
  return updates
    .filter(u => u['Equipment ID'] === id)
    .sort((a,b) => new Date(b.Date+' '+b.Time) - new Date(a.Date+' '+a.Time))[0] || null;
}

function getStatus(id) {
  const latest = getLatestUpdateFor(id);
  if (!latest) return { status:'Unknown', daysDown:0 };

  const isDown = latest.Status !== 'Fixed';
  const downUpdates = updates.filter(u => u['Equipment ID']===id && u.Status!=='Fixed');
  const lastDown = downUpdates.sort((a,b)=>new Date(b.Date+' '+b.Time)-new Date(a.Date+' '+a.Time))[0];

  const daysDown = lastDown ? daysBetween(lastDown.Date+' '+lastDown.Time, new Date()) : 0;

  return {
    status: isDown ? 'Down' : 'Operational',
    daysDown
  };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  UI POPULATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function fillDatalistsAndSelects() {
  const list = document.getElementById('loco-list');
  list.innerHTML = equipment.map(e => `<option value="${e['Loco Number']}">${e['Loco Number']} â€“ ${e.Shaft}</option>`).join('');

  const shaftSel  = document.getElementById('shaft-filter');
  const addShaft  = document.getElementById('shaft');

  const opts = '<option value="">All Shafts / Select...</option>' + SHAFTS.map(s => `<option>${s}</option>`).join('');

  shaftSel.innerHTML = opts;
  addShaft.innerHTML = opts;
}

function populateDashboard(filterShaft = '') {
  const filteredEq = filterShaft ? equipment.filter(e => e.Shaft === filterShaft) : equipment;

  const total     = filteredEq.length;
  let operational = 0, downShort = 0, downLong = 0;

  filteredEq.forEach(e => {
    const st = getStatus(e['Loco Number']);
    if (st.status === 'Operational') operational++;
    else if (st.daysDown <= 7) downShort++;
    else downLong++;
  });

  const availability = total ? ((operational / total) * 100).toFixed(1) : 0;

  document.getElementById('kpi-grid').innerHTML = `
    <div class="kpi-card green"><h2>${operational}</h2><p>Operational</p></div>
    <div class="kpi-card orange"><h2>${downShort}</h2><p>Down < 7 days</p></div>
    <div class="kpi-card red"><h2>${downLong}</h2><p>Down > 7 days</p></div>
    <div class="kpi-card" style="background:#6c5ce7;color:#fff;"><h2>${availability}%</h2><p>Fleet Availability</p></div>`;

  // â”€â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Object.values(charts).forEach(c => c?.destroy());
  charts = {};

  const labels = filteredEq.map(e => e['Loco Number']);

  // Availability
  const availData = filteredEq.map(e => {
    const u = updates.filter(x => x['Equipment ID'] === e['Loco Number']);
    if (!u.length) return 100;
    const downH = u.reduce((s,x)=>s+(Number(x['Downtime Hours'])||0),0);
    const totalH = daysBetween(u[0]?.Date, new Date()) * 24 + 24;
    return totalH > 0 ? ((totalH - downH)/totalH * 100).toFixed(1) : 100;
  });

  charts.availability = new Chart(document.getElementById('availabilityChart'), {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Availability %', data: availData, backgroundColor:'#00d2d3', borderRadius:6 }] },
    options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, max:100 } } }
  });

  // Failures
  const failData = filteredEq.map(e => updates.filter(u => u['Equipment ID']===e['Loco Number'] && u['Is Failure?']==='1').length);

  charts.failures = new Chart(document.getElementById('failuresChart'), {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Failures', data: failData, backgroundColor:'#e74c3c', borderRadius:6 }] },
    options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
  });

  // MTTF
  const mttfData = filteredEq.map(e => {
    const fu = updates.filter(u => u['Equipment ID']===e['Loco Number'] && u['Is Failure?']==='1').length;
    if (!fu) return null;
    const totalOpDays = /* simplistic */ 30; // â† improve later
    return (totalOpDays / fu).toFixed(1);
  }).filter(v => v !== null);

  charts.mttf = new Chart(document.getElementById('mttfChart'), {
    type: 'bar',
    data: { labels: labels.filter((_,i)=>mttfData[i]!==null), datasets: [{ label: 'MTTF Days', data: mttfData, backgroundColor:'#3498db', borderRadius:6 }] },
    options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
  });

  // â”€â”€â”€ Alerts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const highRisk = filteredEq.filter(e => getStatus(e['Loco Number']).daysDown > 7);
  document.getElementById('high-risk-list').innerHTML = highRisk.map(e=>`
    <li class="alert-item">
      <span>Loco ${e['Loco Number']} â€“ ${e.Shaft}</span>
      <span class="risk-badge risk-high">CRITICAL</span>
    </li>`).join('');
  document.getElementById('high-risk-alerts').classList.toggle('hidden', highRisk.length === 0);

  // Predictive / upcoming maintenance
  const upcoming = maintenance
    .filter(m => !isNaN(calculateDaysLeft(m.lastDone, m.interval)))
    .sort((a,b) => calculateDaysLeft(a.lastDone,a.interval) - calculateDaysLeft(b.lastDone,b.interval));

  document.getElementById('maintenance-list').innerHTML = upcoming.map(m => {
    const days = calculateDaysLeft(m.lastDone, m.interval);
    const txt = days >= 0 ? `${days} days left` : `${Math.abs(days)} days overdue`;
    const col = days > 5 ? '#2ecc71' : '#e74c3c';
    return `<div style="padding:10px 0;border-bottom:1px solid rgba(255,255,255,.12);display:flex;justify-content:space-between;">
      <span><strong>${m.equipment}</strong> â€“ ${m.task}</span>
      <span style="color:${col};font-weight:700;">${txt}</span>
    </div>`;
  }).join('');

  const predictive = upcoming.filter(m => calculateDaysLeft(m.lastDone, m.interval) <= 7);
  document.getElementById('predictive-list').innerHTML = predictive.map(m => {
    const days = calculateDaysLeft(m.lastDone, m.interval);
    return `<li class="alert-item">
      <span>${m.equipment} â€“ ${m.task}</span>
      <span class="risk-badge risk-predict">${days >= 0 ? days+' days' : 'OVERDUE'}</span>
    </li>`;
  }).join('');
  document.getElementById('predictive-alerts').classList.toggle('hidden', predictive.length === 0);
}

function populateMaintenanceTable() {
  const tbody = document.querySelector('#maint-table tbody');
  tbody.innerHTML = maintenance.map((m,i) => {
    const days = calculateDaysLeft(m.lastDone, m.interval);
    const disp = isNaN(days) ? 'â€”' : (days >= 0 ? days : Math.abs(days)+' overdue');
    const color = days > 5 ? '#2ecc71' : '#e74c3c';
    return `<tr>
      <td>${m.equipment}</td>
      <td>${m.task}</td>
      <td>${m.interval}</td>
      <td>${m.lastDone || 'â€”'}</td>
      <td>${calculateNextDue(m.lastDone, m.interval) || 'â€”'}</td>
      <td style="color:${color};font-weight:700;">${disp}</td>
      <td style="display:flex;gap:8px;">
        <button class="success" onclick="markMaintenanceDone(${i})">Done</button>
      </td>
    </tr>`;
  }).join('');
}

function markMaintenanceDone(index) {
  maintenance[index].lastDone = new Date().toISOString().split('T')[0];
  saveData('maintenance', maintenance);
  populateMaintenanceTable();
  populateDashboard(document.getElementById('shaft-filter').value);
}

function populateLogTable() {
  const tbody = document.querySelector('#log-table tbody');
  tbody.innerHTML = [...updates]
    .sort((a,b) => new Date(b.Date+' '+b.Time) - new Date(a.Date+' '+a.Time))
    .map(u => `<tr>
      <td>${u.Date}</td>
      <td>${u.Time}</td>
      <td>${u['Equipment ID']}</td>
      <td>${u.Status}</td>
      <td>${u.Shift}</td>
      <td>${u['Reason/Fault']}</td>
      <td>${Number(u['Downtime Hours']||0).toFixed(1)}</td>
      <td>${u['Is Failure?']==='1'?'Yes':'No'}</td>
    </tr>`).join('');
}

function populateSummaryTable() {
  const tbody = document.querySelector('#summary-table tbody');
  tbody.innerHTML = equipment.map(e => {
    const id = e['Loco Number'];
    const ups = updates.filter(u => u['Equipment ID'] === id);
    const downH = ups.reduce((s,u)=>s + (Number(u['Downtime Hours'])||0), 0);
    const failCount = ups.filter(u=>u['Is Failure?']==='1').length;
    const last = ups.sort((a,b)=>new Date(b.Date+' '+b.Time)-new Date(a.Date+' '+a.Time))[0];
    const st = getStatus(id);
    return `<tr>
      <td>${id}</td>
      <td>${ups.length}</td>
      <td>â€”</td>
      <td>${(downH/24).toFixed(1)}</td>
      <td>â€”</td>
      <td>${failCount}</td>
      <td>â€”</td>
      <td>â€”</td>
      <td>${last ? last.Date+' '+last.Time : 'â€”'}</td>
      <td>${st.status}</td>
    </tr>`;
  }).join('');
}

function populateEquipmentTable() {
  document.querySelector('#equipment-table tbody').innerHTML = equipment.map(e => `
    <tr>
      <td>${e.Shaft}</td>
      <td>${e.Level}</td>
      <td>${e['Loco Size']}</td>
      <td>${e['Loco Number']}</td>
      <td>${e.SECTION}</td>
    </tr>`).join('');
}

function showSection(section) {
  document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
  document.getElementById(section).classList.remove('hidden');

  document.querySelectorAll('#sidebar-menu li').forEach(li => li.classList.remove('active'));
  document.querySelector(`#sidebar-menu li[data-section="${section}"]`)?.classList.add('active');

  if (section === 'dashboard')          populateDashboard(document.getElementById('shaft-filter').value);
  if (section === 'status-log')         populateLogTable();
  if (section === 'summary')            populateSummaryTable();
  if (section === 'manage-equipment')   populateEquipmentTable();
  if (section === 'maintenance-schedule') populateMaintenanceTable();
  if (section === 'calendar')           initCalendar();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CALENDAR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function initCalendar() {
  if (calendar) {
    calendar.destroy();
    calendar = null;
  }

  const el = document.getElementById('calendar-div');
  if (!el) return;

  calendar = new FullCalendar.Calendar(el, {
    initialView: 'dayGridMonth',
    headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek' },
    events: maintenance.map(m => {
      const due = calculateNextDue(m.lastDone, m.interval);
      if (!due) return null;
      const daysLeft = calculateDaysLeft(m.lastDone, m.interval);
      let color = '#22c55e';
      if (daysLeft < 0) color = '#ef4444';
      else if (daysLeft <= 7) color = '#f59e0b';
      return {
        title: `${m.equipment} â€“ ${m.task}`,
        start: due,
        allDay: true,
        backgroundColor: color,
        borderColor: color,
        textColor: '#000'
      };
    }).filter(Boolean)
  });

  calendar.render();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FORM HANDLERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('add-eq-form').addEventListener('submit', e => {
  e.preventDefault();
  const form = e.target;
  const newItem = {
    Shaft:        form.querySelector('#shaft').value,
    Level:        form.querySelector('#level').value.trim(),
    'Loco Size':  form.querySelector('#loco-size').value.trim(),
    'Loco Number':form.querySelector('#loco-number').value.trim(),
    SECTION:      form.querySelector('#section').value.trim()
  };
  if (!newItem['Loco Number']) return alert("Loco Number is required");
  equipment.push(newItem);
  saveData('equipment', equipment);
  fillDatalistsAndSelects();
  populateDashboard();
  populateEquipmentTable();
  form.reset();
});

document.getElementById('add-status-form').addEventListener('submit', e => {
  e.preventDefault();
  const form = e.target;
  updates.push({
    Date:          form.querySelector('#u-date').value,
    Time:          form.querySelector('#u-time').value,
    'Equipment ID':form.querySelector('#u-loco').value.trim(),
    Status:        form.querySelector('#u-status').value,
    Shift:         form.querySelector('#u-shift').value,
    'Reason/Fault':form.querySelector('#u-reason').value.trim(),
    'Downtime Hours': Number(form.querySelector('#u-downtime').value) || 0,
    'Is Failure?': form.querySelector('#u-failure').value
  });
  saveData('updates', updates);
  populateDashboard();
  populateLogTable();
  populateSummaryTable();
  form.reset();
});

document.getElementById('search-form').addEventListener('submit', e => {
  e.preventDefault();
  const id   = document.getElementById('s-loco').value.trim();
  const date = document.getElementById('s-date').value;
  const all  = document.getElementById('show-all-history').checked;

  if (!id) return alert('Please enter Equipment ID');

  const eq = equipment.find(e => e['Loco Number'] === id);
  if (!eq) return document.getElementById('search-results').innerHTML = '<p style="color:#e74c3c;">Equipment not found.</p>';

  let filtered = updates.filter(u => u['Equipment ID'] === id);
  if (date && !all) filtered = filtered.filter(u => u.Date === date);
  filtered.sort((a,b) => new Date(b.Date+' '+b.Time) - new Date(a.Date+' '+a.Time));

  let html = `
    <div style="background:rgba(13,71,161,.15);padding:1.2rem;border-radius:10px;margin-bottom:1.2rem;">
      <strong>${eq['Loco Number']} â€“ ${eq.Shaft}</strong><br>
      Level: ${eq.Level} | Size: ${eq['Loco Size']} | Section: ${eq.SECTION}
    </div>`;

  if (!filtered.length) {
    html += '<p style="color:#f39c12;">No updates found.</p>';
  } else {
    html += filtered.map(u => `
      <div style="padding:12px;border-bottom:1px solid rgba(255,255,255,.12);">
        <strong>${u.Date} ${u.Time}</strong> â€“ 
        <span style="color:${u.Status==='Fixed'?'#2ecc71':'#e74c3c'}">${u.Status}</span>:
        ${u['Reason/Fault']}
        ${u['Downtime Hours'] ? ` (${u['Downtime Hours']} h)` : ''}
        ${u['Is Failure?']==='1' ? '<span class="risk-badge risk-high" style="margin-left:10px;">FAILURE</span>' : ''}
      </div>`).join('');
  }

  document.getElementById('search-results').innerHTML = html;
});

document.getElementById('add-maint-form').addEventListener('submit', e => {
  e.preventDefault();
  const form = e.target;
  maintenance.push({
    equipment: form[0].value.trim(),
    task:      form[1].value.trim(),
    interval:  form[2].value,
    lastDone:  form[3].value
  });
  saveData('maintenance', maintenance);
  populateMaintenanceTable();
  populateDashboard();
  initCalendar();
  document.getElementById('add-maint-modal').classList.remove('active');
  form.reset();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SIDEBAR & INITIALIZATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.querySelectorAll('#sidebar-menu li').forEach(li => {
  li.addEventListener('click', () => {
    showSection(li.dataset.section);
    if (window.innerWidth < 1025) document.getElementById('sidebar').classList.remove('open');
  });
});

document.addEventListener('click', e => {
  const sb = document.getElementById('sidebar');
  const ham = document.querySelector('.hamburger');
  if (!sb.contains(e.target) && !ham.contains(e.target) && sb.classList.contains('open')) {
    sb.classList.remove('open');
  }
});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

loadData();
fillDatalistsAndSelects();
populateDashboard();
populateLogTable();
populateSummaryTable();
populateEquipmentTable();
populateMaintenanceTable();
showSection('dashboard');

// Set default dates
document.querySelectorAll('input[type="date"]').forEach(el => {
  if (!el.value) el.value = new Date().toISOString().split('T')[0];
});

</script>
</body>
</html>
