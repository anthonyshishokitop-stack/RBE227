<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Impala RBE Monitor - Platinum Operations</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <style>
        :root {
            --bg: #0a0e17;
            --card: #1a2332;
            --txt: #e2e8f0;
            --border: #334155;
            --hdr: #1e293b;
            --prim: #0d47a1;
            --prim-light: #1976d2;
            --succ: #2ecc71;
            --warn: #f39c12;
            --danger: #e74c3c;
            --maint: #3498db;
            --high: #e74c3c;
            --pred: #e67e22;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            --radius: 16px;
            --gap: 28px;
            --pad: 32px;
            --accent-gold: #f4c542;
            --teal: #008080;
        }

        [data-theme="light"] {
            --bg: #f8fafc;
            --card: #ffffff;
            --txt: #1e293b;
            --border: #cbd5e1;
            --hdr: #f1f5f9;
        }

        *, *:before, *:after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            font-family: 'Roboto', sans-serif;
            background: var(--bg);
            color: var(--txt);
            overflow-x: hidden;
        }

        body {
            background-image: url('https://images.unsplash.com/photo-1565538810648-7f5a2c106b8f?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            display: flex;
            flex-direction: column;
        }

        h1, h2, h3, h4 {
            margin: 0 0 0.5em;
            color: var(--prim);
            font-weight: 700;
        }

        h1 {
            font-size: clamp(1.9rem, 4vw, 2.5rem);
        }

        h2 {
            font-size: 1.6rem;
        }

        .wrapper {
            display: flex;
            flex: 1;
        }

        .sidebar {
            position: sticky;
            top: 0;
            height: 100vh;
            width: 280px;
            background: var(--prim);
            color: #fff;
            padding: var(--pad);
            box-shadow: 8px 0 40px rgba(0, 0, 0, 0.25);
            overflow-y: auto;
            z-index: 10;
            display: flex;
            flex-direction: column;
        }

        .sidebar .logo-container {
            text-align: center;
            margin-bottom: 3rem;
            flex-shrink: 0;
        }

        .sidebar .logo-img {
            max-width: 160px;
            display: block;
            margin: 0 auto;
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
        }

        .theme-toggle {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
            color: var(--txt);
        }

        .theme-toggle:hover {
            transform: scale(1.15);
            background: rgba(255, 255, 255, 0.18);
        }

        #sidebar-menu {
            list-style: none;
            flex: 1;
        }

        #sidebar-menu li {
            padding: 16px 20px;
            margin: 10px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.35s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        #sidebar-menu li span {
            flex: 1;
            font-size: 1.02rem;
        }

        #sidebar-menu li:hover {
            background: var(--prim-light);
            transform: translateX(4px);
        }

        #sidebar-menu li.active {
            background: var(--prim-light);
            font-weight: 700;
        }

        .main {
            flex: 1;
            padding: var(--gap);
            overflow-y: auto;
        }

        .container {
            max-width: 1700px;
            margin: 0 auto;
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: var(--pad);
            min-height: 100%;
        }

        .header-bar {
            background: linear-gradient(135deg, var(--prim), var(--prim-light));
            color: #fff;
            padding: 1.4rem 2rem;
            border-radius: var(--radius) var(--radius) 0 0;
            margin: -var(--pad) -var(--pad) var(--gap) -var(--pad);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-bar h1 {
            color: #fff;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
            gap: var(--gap);
            margin: 2.2rem 0;
        }

        .kpi-card {
            padding: 2rem;
            border-radius: var(--radius);
            text-align: center;
            color: #fff;
            box-shadow: var(--shadow);
            font-weight: 800;
        }

        .kpi-card h2 {
            font-size: 2.5rem;
            margin: 0;
            color: #fff;
        }

        .kpi-card p {
            font-size: 1.05rem;
            opacity: 0.95;
        }

        .kpi-card.green {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .kpi-card.orange {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .kpi-card.red {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .chart-wrapper {
            background: var(--card);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin: 2.2rem 0;
        }

        .chart-title {
            font-weight: 700;
            color: var(--prim);
            margin-bottom: 1.2rem;
            font-size: 1.3rem;
        }

        .alert-banner {
            padding: 1.5rem 1.8rem;
            border-radius: var(--radius);
            margin: 1.8rem 0;
            box-shadow: var(--shadow);
            border-left: 8px solid;
            font-weight: 700;
        }

        .alert-high-risk {
            background: rgba(231, 76, 60, 0.18);
            color: var(--high);
            border-color: var(--high);
        }

        .alert-predictive {
            background: rgba(230, 126, 34, 0.18);
            color: var(--pred);
            border-color: var(--pred);
        }

        .alert-list {
            list-style: none;
            margin: 1.2rem 0 0;
        }

        .alert-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem 1.4rem;
            margin: 8px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .risk-badge {
            padding: 7px 18px;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 900;
            color: #fff;
        }

        .risk-high {
            background: var(--high);
        }

        .form-group {
            margin: 1.4rem 0;
        }

        .form-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 0.6rem;
            color: var(--prim);
        }

        input, select, textarea {
            width: 100%;
            padding: 16px 18px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--card);
            color: var(--txt);
            font-size: 1.05rem;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--prim);
            box-shadow: 0 0 0 5px rgba(13, 71, 161, 0.25);
        }

        button {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.4s;
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.25);
            font-size: 1.05rem;
        }

        button:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
        }

        button.primary {
            background: linear-gradient(135deg, var(--prim), var(--prim-light));
            color: #fff;
        }

        button.warn {
            background: var(--warn);
            color: #000;
        }

        button.maint {
            background: var(--maint);
            color: #fff;
        }

        button.export {
            margin-left: 12px;
            padding: 12px 20px;
            font-size: 0.95rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.8rem 0;
            font-size: 0.98rem;
        }

        th, td {
            padding: 18px 16px;
            border-bottom: 1px solid var(--border);
            text-align: left;
        }

        th {
            background: var(--teal);
            color: #fff;
            font-weight: 700;
        }

        tr:hover {
            background: rgba(13, 71, 161, 0.1);
        }

        .hidden {
            display: none !important;
        }

        .maint-actions {
            display: flex;
            gap: 8px;
        }

        .maint-actions button {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 8px;
        }

        .maint-actions .done-btn {
            background: #2ecc71;
            color: #fff;
        }

        .maint-actions .edit-btn {
            background: #3498db;
            color: #fff;
        }

        .maint-actions .delete-btn {
            background: #e74c3c;
            color: #fff;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card);
            padding: 2rem;
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--prim);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--txt);
        }

        .chart-container {
            position: relative;
            height: 360px;
        }

        #calendar-div {
            background: var(--card);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            min-height: 600px;
        }

        @media (max-width: 768px) {
            .wrapper {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
            }
            .main {
                padding: 1.4rem;
            }
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            .header-bar {
                flex-direction: column;
                gap: 1.2rem;
            }
        }
    </style>
</head>

<body data-theme="dark">
    <!-- MODALS -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Maintenance Task</h3>
                <button class="close-modal" onclick="closeEditModal()">‚úï</button>
            </div>
            <form id="edit-maint-form">
                <input type="hidden" id="edit-index">
                <div class="form-group">
                    <label>Equipment</label>
                    <input id="edit-equipment" list="loco-list" required>
                </div>
                <div class="form-group">
                    <label>Task</label>
                    <input id="edit-task" type="text" required>
                </div>
                <div class="form-group">
                    <label>Interval</label>
                    <select id="edit-interval" required>
                        <option>weekly</option>
                        <option>monthly</option>
                        <option>quarterly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Last Done</label>
                    <input id="edit-last" type="date" required>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="warn" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-maint-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Maintenance Task</h3>
                <button class="close-modal" onclick="closeAddMaintModal()">‚úï</button>
            </div>
            <form id="add-maint-form">
                <div class="form-group">
                    <label>Equipment</label>
                    <input list="loco-list" required>
                </div>
                <div class="form-group">
                    <label>Task</label>
                    <input type="text" required>
                </div>
                <div class="form-group">
                    <label>Interval</label>
                    <select required>
                        <option>weekly</option>
                        <option>monthly</option>
                        <option>quarterly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Last Done</label>
                    <input type="date" id="m-last" required>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="warn" onclick="closeAddMaintModal()">Cancel</button>
                    <button type="submit" class="primary">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <datalist id="loco-list"></datalist>

    <div class="wrapper">
        <div class="sidebar">
            <div class="logo-container">
                <img class="logo-img" src="https://apventures.com/wp-content/uploads/2023/06/image-35.jpeg" alt="Logo">
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
            <ul id="sidebar-menu">
                <li class="active" data-section="dashboard"><span>üìä Dashboard</span></li>
                <li data-section="add-equipment"><span>üîß Equipment</span></li>
                <li data-section="add-status"><span>üìù Status Update</span></li>
                <li data-section="search-status"><span>üîç Search</span></li>
                <li data-section="status-log"><span>üìã Full Log</span></li>
                <li data-section="summary"><span>üìä Analytics</span></li>
                <li data-section="manage-equipment"><span>‚öôÔ∏è Equipment List</span></li>
                <li data-section="maintenance-schedule"><span>üõ†Ô∏è Maintenance</span></li>
                <li data-section="calendar"><span>üìÖ Calendar</span></li>
                <li data-section="operations-report"><span>üìà Ops Report</span></li>
            </ul>
        </div>

        <div class="main">
            <div class="container">
                <!-- DASHBOARD -->
                <section id="dashboard">
                    <div class="header-bar">
                        <h1>REAL-TIME PLATINUM OPERATIONS</h1>
                        <div style="display: flex; gap: 14px; align-items: center;">
                            <select id="shaft-filter" style="padding: 12px 16px; border-radius: 12px; border: none; font-weight: 600; background: #fff; color: #000;" onchange="filterDashboard()"></select>
                            <button class="export primary" onclick="exportDashboardPDF()">Export PDF</button>
                        </div>
                    </div>

                    <div id="high-risk-alerts" class="alert-banner alert-high-risk hidden">
                        <strong>‚ö†Ô∏è HIGH RISK EQUIPMENT</strong>
                        <ul id="high-risk-list" class="alert-list"></ul>
                    </div>

                    <div id="predictive-alerts" class="alert-banner alert-predictive hidden">
                        <strong>üîß PREDICTIVE MAINTENANCE</strong>
                        <ul id="predictive-list" class="alert-list"></ul>
                    </div>

                    <div class="kpi-grid" id="kpi-grid"></div>

                    <div class="chart-wrapper">
                        <div class="chart-title">Equipment Availability (%)</div>
                        <div class="chart-container"><canvas id="availabilityChart"></canvas></div>
                    </div>

                    <div class="chart-wrapper">
                        <div class="chart-title">Failure Count by Equipment</div>
                        <div class="chart-container"><canvas id="failuresChart"></canvas></div>
                    </div>

                    <div class="chart-wrapper">
                        <div class="chart-title">MTTF (Mean Time To Failure) - Days</div>
                        <div class="chart-container"><canvas id="mttfChart"></canvas></div>
                    </div>

                    <div class="chart-wrapper">
                        <div class="chart-title">Delay Reasons (This Week)</div>
                        <div class="chart-container"><canvas id="delayChart"></canvas></div>
                    </div>

                    <div class="upcoming-maintenance" id="upcoming-maintenance" style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(52, 152, 219, 0.05)); padding: 2rem; border-radius: var(--radius); border-left: 8px solid var(--maint); margin-top: 2.2rem;">
                        <h3 style="color: var(--maint); margin-bottom: 1.4rem;">üìã Upcoming Maintenance Schedule</h3>
                        <div id="maintenance-list"></div>
                    </div>
                </section>

                <!-- ADD EQUIPMENT -->
                <section id="add-equipment" class="hidden">
                    <div class="header-bar">
                        <h1>Add New Equipment</h1>
                    </div>
                    <form id="add-eq-form" style="max-width: 600px; margin-top: 2rem;">
                        <div class="form-group">
                            <label>Shaft</label>
                            <select id="shaft" required></select>
                        </div>
                        <div class="form-group">
                            <label>Level</label>
                            <input id="level" type="text" required>
                        </div>
                        <div class="form-group">
                            <label>Loco Size</label>
                            <input id="loco-size" type="text" required>
                        </div>
                        <div class="form-group">
                            <label>Loco Number</label>
                            <input id="loco-number" type="text" required>
                        </div>
                        <div class="form-group">
                            <label>SECTION</label>
                            <input id="section" type="text" required>
                        </div>
                        <button type="submit" class="primary">Add Equipment</button>
                    </form>
                </section>

                <!-- STATUS UPDATE -->
                <section id="add-status" class="hidden">
                    <div class="header-bar">
                        <h1>Status Update</h1>
                    </div>
                    <form id="add-status-form" style="max-width: 600px; margin-top: 2rem;">
                        <div class="form-group">
                            <label>Date</label>
                            <input id="u-date" type="date" required>
                        </div>
                        <div class="form-group">
                            <label>Time</label>
                            <input id="u-time" type="time" required>
                        </div>
                        <div class="form-group">
                            <label>Equipment ID</label>
                            <input id="u-loco" list="loco-list" required>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="u-status">
                                <option>Fixed</option>
                                <option>Down</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Shift</label>
                            <select id="u-shift">
                                <option>Morning</option>
                                <option>Afternoon</option>
                                <option>Night</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Reason/Fault</label>
                            <textarea id="u-reason" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Downtime Hours</label>
                            <input id="u-downtime" type="number" step="0.1" min="0">
                        </div>
                        <div class="form-group">
                            <label>Is Failure?</label>
                            <select id="u-failure">
                                <option value="0">No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <button type="submit" class="primary">Submit Update</button>
                    </form>
                </section>

                <!-- SEARCH -->
                <section id="search-status" class="hidden">
                    <div class="header-bar">
                        <h1>Search Status</h1>
                    </div>
                    <form id="search-form" style="display: flex; gap: 14px; align-items: flex-end; flex-wrap: wrap; max-width: 800px; margin-top: 2rem;">
                        <div class="form-group">
                            <label>Equipment ID</label>
                            <input id="s-loco" list="loco-list">
                        </div>
                        <div class="form-group">
                            <label>Date (optional)</label>
                            <input id="s-date" type="date">
                        </div>
                        <div class="form-group">
                            <label>Job Order Equipment</label>
                            <select id="job-loco">
                                <option value="">Select Equipment</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="show-all-history">
                            <label for="show-all-history" style="margin: 0; font-weight: 600;">Show Full History</label>
                        </div>
                        <button type="submit" class="primary">Search</button>
                        <button type="button" class="maint" onclick="generateJobPDF()">Job Order PDF</button>
                    </form>
                    <div id="search-results" style="margin-top: 1.8rem;"></div>
                </section>

                <!-- FULL LOG -->
                <section id="status-log" class="hidden">
                    <div class="header-bar">
                        <h1>Full Status Log</h1>
                        <button class="export primary" onclick="exportLogCSV()">Export CSV</button>
                    </div>
                    <table id="log-table" style="margin-top: 1.8rem;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Equipment ID</th>
                                <th>Status</th>
                                <th>Shift</th>
                                <th>Fault</th>
                                <th>Down Hrs</th>
                                <th>Failure</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </section>

                <!-- ANALYTICS -->
                <section id="summary" class="hidden">
                    <div class="header-bar">
                        <h1>Fleet Analytics</h1>
                        <button class="export primary" onclick="exportAnalyticsPDF()">Export Report</button>
                    </div>
                    <table id="summary-table" style="margin-top: 1.8rem;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Updates</th>
                                <th>Total Days</th>
                                <th>Down Days</th>
                                <th>Op Days</th>
                                <th>Failures</th>
                                <th>MTTF</th>
                                <th>Avail %</th>
                                <th>Last Update</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </section>

                <!-- EQUIPMENT LIST -->
                <section id="manage-equipment" class="hidden">
                    <div class="header-bar">
                        <h1>Equipment List</h1>
                    </div>
                    <table id="equipment-table" style="margin-top: 1.8rem;">
                        <thead>
                            <tr>
                                <th>Shaft</th>
                                <th>Level</th>
                                <th>Size</th>
                                <th>Loco Number</th>
                                <th>SECTION</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </section>

                <!-- MAINTENANCE SCHEDULE -->
                <section id="maintenance-schedule" class="hidden">
                    <div class="header-bar">
                        <h1>Maintenance Schedule</h1>
                        <div>
                            <button class="primary" onclick="document.getElementById('add-maint-modal').classList.add('active')">Add Task</button>
                            <button class="export primary" onclick="exportMaintPDF()">Export PDF</button>
                        </div>
                    </div>
                    <table id="maint-table" style="margin-top: 1.8rem;">
                        <thead>
                            <tr>
                                <th>Equipment</th>
                                <th>Task</th>
                                <th>Interval</th>
                                <th>Last Done</th>
                                <th>Due</th>
                                <th>Days Left</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </section>

                <!-- CALENDAR -->
                <section id="calendar" class="hidden">
                    <div class="header-bar">
                        <h1>Maintenance Calendar</h1>
                    </div>
                    <div id="calendar-div"></div>
                </section>

                <!-- OPERATIONS REPORT -->
                <section id="operations-report" class="hidden">
                    <div class="header-bar">
                        <h1>All Operations Report</h1>
                        <button class="export primary" onclick="exportOperationsReportPDF()">Export Report</button>
                    </div>

                    <div style="background: var(--card); padding: 2rem; border-radius: var(--radius); margin: 1.8rem 0;">
                        <h2 style="color: var(--teal); margin-bottom: 1rem;">Operation Status</h2>
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody id="op-status-tbody"></tbody>
                        </table>
                    </div>

                    <div style="background: var(--card); padding: 2rem; border-radius: var(--radius); margin: 1.8rem 0;">
                        <h2 style="color: var(--teal); margin-bottom: 1rem;">Problem Equipment</h2>
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Equipment ID</th>
                                    <th>Status</th>
                                    <th>Color</th>
                                    <th>Last Reason/Fault</th>
                                    <th>Total Downtime Hours</th>
                                </tr>
                            </thead>
                            <tbody id="problem-equipment-tbody"></tbody>
                        </table>
                    </div>

                    <div style="background: var(--card); padding: 2rem; border-radius: var(--radius); margin: 1.8rem 0;">
                        <h2 style="color: var(--teal); margin-bottom: 1rem;">High Risk Equipment</h2>
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Equipment ID</th>
                                    <th>Number of Failures</th>
                                    <th>MTTF (Days)</th>
                                    <th>Availability %</th>
                                </tr>
                            </thead>
                            <tbody id="high-risk-tbody"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Firebase SDK compat version -->
    <script src="https://www.gstatic.com/firebaseapp/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebaseapp/10.14.1/firebase-database-compat.js"></script>

    <script>
        // FIREBASE CONFIGURATION - REPLACE WITH YOUR ACTUAL CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDlbzmgZykYM9uHoGFW8jFKZxxs1mAaMJM",
            authDomain: "rbemine-972a8.firebaseapp.com",
            projectId: "rbemine-972a8",
            storageBucket: "rbemine-972a8.firebasestorage.app",
            messagingSenderId: "188009589982",
            appId: "1:188009589982:web:61114e6ea73fd22ccc664f",
            measurementId: "G-17TT2XN7T3"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const equipmentRef = db.ref("equipment");
        const updatesRef = db.ref("updates");
        const maintenanceRef = db.ref("maintenance");
        const delaysRef = db.ref("delays");

        let eq = [], up = [], mt = [], delaysData = [], calendar = null, charts = {};

        const shafts = [
            "0 Shaft", "1 Shaft", "2 Shaft", "3 Shaft", "4 Shaft", "5 Shaft", "6 Shaft",
            "7 Shaft", "7A Shaft", "8 Shaft", "9 Shaft", "10 Shaft", "10D", "11 Shaft",
            "11C Shaft", "11D", "12 Shaft", "12 North Shaft", "12S", "14 Shaft", "14D",
            "16 Shaft", "17 Shaft", "20 Shaft", "CLAPHAM", "DRIKOP", "EF Shaft",
            "NORTH SHAFT", "SOUTH SHAFT", "STYLDRIFT", "Winnaarshoek", "Forest Hill",
            "Offset Underground", "UG2 Main Decline", "Merensky Main Decline", "UG2 North Decline",
            "367-KT Kalkfontein", "368-KT Buffelshoek", "370-KT Richmond", "372-KT Dwarsrivier",
            "373-KT De Grooteboom", "374-KT Tweefontein", "Leeuwkop Shaft"
        ];

        // THEME TOGGLE
        function toggleTheme() {
            const cur = document.body.getAttribute("data-theme") || "dark";
            const newTheme = cur === "dark" ? "light" : "dark";
            document.body.setAttribute("data-theme", newTheme);
            localStorage.setItem("theme", newTheme);
        }

        window.addEventListener("load", () => {
            const saved = localStorage.getItem("theme") || "dark";
            document.body.setAttribute("data-theme", saved);
        });

        // DATE CALCULATIONS
        function calculateNextDue(lastDone, interval) {
            if (!lastDone) return null;
            const d = new Date(lastDone);
            if (interval === "weekly") d.setDate(d.getDate() + 7);
            else if (interval === "monthly") d.setMonth(d.getMonth() + 1);
            else if (interval === "quarterly") d.setMonth(d.getMonth() + 3);
            return d.toISOString().slice(0, 10);
        }

        function calculateDaysLeft(lastDone, interval) {
            if (!lastDone) return NaN;
            const next = new Date(calculateNextDue(lastDone, interval));
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            next.setHours(0, 0, 0, 0);
            return Math.ceil((next - today) / 86400000);
        }

        // NAVIGATION
        document.querySelectorAll("#sidebar-menu li").forEach(li => {
            li.addEventListener("click", () => show(li.dataset.section));
        });

        function show(section) {
            document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
            const el = document.getElementById(section);
            if (el) el.classList.remove("hidden");
            document.querySelectorAll("#sidebar-menu li").forEach(l => l.classList.remove("active"));
            const activeLi = document.querySelector(`#sidebar-menu li[data-section="${section}"]`);
            if (activeLi) activeLi.classList.add("active");

            if (section === "calendar") setTimeout(initCalendar, 0);
            if (section === "maintenance-schedule") populateMaintTable();
            if (section === "operations-report") populateOperationsReport();
        }

        // CALENDAR
        function initCalendar() {
            const el = document.getElementById("calendar-div");
            if (!el) return;
            if (calendar) calendar.destroy();

            const events = mt.map(m => ({
                title: `${m.equipment} - ${m.task}`,
                start: calculateNextDue(m.lastDone, m.interval),
                backgroundColor: "#3498db",
                borderColor: "#2980b9",
                textColor: "#fff"
            }));

            calendar = new FullCalendar.Calendar(el, {
                initialView: "dayGridMonth",
                height: "auto",
                headerToolbar: { left: "prev,next today", center: "title", right: "dayGridMonth,timeGridWeek" },
                events: events,
                eventDisplay: "block",
                dayMaxEvents: true,
                contentHeight: "auto"
            });
            calendar.render();
        }

        // MAINTENANCE TABLE
        function populateMaintTable() {
            const tbody = document.querySelector("#maint-table tbody");
            tbody.innerHTML = mt.map((m, i) => {
                const next = calculateNextDue(m.lastDone, m.interval);
                const days = calculateDaysLeft(m.lastDone, m.interval);
                const display = isNaN(days) ? "-" : days <= 0 ? `${-days} overdue` : `${days} days`;
                const color = days <= 3 ? "#2ecc71" : "#e74c3c";

                return `<tr>
                    <td>${m.equipment}</td>
                    <td>${m.task}</td>
                    <td>${m.interval}</td>
                    <td>${m.lastDone}</td>
                    <td>${next}</td>
                    <td style="color: ${color}; font-weight: 700;">${display}</td>
                    <td class="maint-actions">
                        <button class="done-btn" onclick="markDone('${m.key}')">Done</button>
                        <button class="edit-btn" onclick="openEditModal('${m.key}')">Edit</button>
                        <button class="delete-btn" onclick="deleteMaint('${m.key}')">Delete</button>
                    </td>
                </tr>`;
            }).join("");
        }

        function markDone(key) {
            const today = new Date().toISOString().slice(0, 10);
            maintenanceRef.child(key).update({ lastDone: today });
        }

        function deleteMaint(key) {
            if (confirm("Delete this task?")) {
                maintenanceRef.child(key).remove();
            }
        }

        function openEditModal(key) {
            const m = mt.find(task => task.key === key);
            if (!m) return;
            document.getElementById("edit-index").value = key;
            document.getElementById("edit-equipment").value = m.equipment;
            document.getElementById("edit-task").value = m.task;
            document.getElementById("edit-interval").value = m.interval;
            document.getElementById("edit-last").value = m.lastDone;
            document.getElementById("edit-modal").classList.add("active");
        }

        function closeEditModal() {
            document.getElementById("edit-modal").classList.remove("active");
        }

        function closeAddMaintModal() {
            document.getElementById("add-maint-modal").classList.remove("active");
        }

        // FORMS
        document.getElementById("add-maint-form").onsubmit = (e) => {
            e.preventDefault();
            const newTask = {
                equipment: e.target[0].value.trim(),
                task: e.target[1].value.trim(),
                interval: e.target[2].value,
                lastDone: e.target[3].value
            };
            maintenanceRef.push(newTask);
            closeAddMaintModal();
            e.target.reset();
        };

        document.getElementById("edit-maint-form").onsubmit = (e) => {
            e.preventDefault();
            const key = document.getElementById("edit-index").value;
            const updatedTask = {
                equipment: e.target[0].value.trim(),
                task: e.target[1].value.trim(),
                interval: e.target[2].value,
                lastDone: e.target[3].value
            };
            maintenanceRef.child(key).update(updatedTask);
            closeEditModal();
        };

        document.getElementById("add-eq-form").onsubmit = (e) => {
            e.preventDefault();
            const newEq = {
                Shaft: e.target[0].value,
                Level: e.target[1].value,
                "Loco Size": e.target[2].value,
                "Loco Number": e.target[3].value,
                SECTION: e.target[4].value
            };
            equipmentRef.push(newEq);
            e.target.reset();
        };

        document.getElementById("add-status-form").onsubmit = (e) => {
            e.preventDefault();
            const newUpdate = {
                Date: e.target[0].value,
                Time: e.target[1].value,
                "Equipment ID": e.target[2].value,
                Status: e.target[3].value,
                Shift: e.target[4].value,
                ReasonFault: e.target[5].value,
                "Downtime Hours": parseFloat(e.target[6].value) || 0,
                "Is Failure?": parseInt(e.target[7].value)
            };
            updatesRef.push(newUpdate);
            e.target.reset();
        };

        // REAL-TIME LISTENERS
        equipmentRef.on("value", (snap) => {
            eq = [];
            snap.forEach(child => {
                eq.push({ ...child.val(), key: child.key });
            });
            fillDatalist();
            populateDashboard();
            populateEquipmentTable();
            populateSummaryTable();
        });

        updatesRef.on("value", (snap) => {
            up = [];
            snap.forEach(child => {
                up.push({ ...child.val(), key: child.key });
            });
            populateDashboard();
            populateLogTable();
            populateSummaryTable();
        });

        maintenanceRef.on("value", (snap) => {
            mt = [];
            snap.forEach(child => {
                mt.push({ ...child.val(), key: child.key });
            });
            populateMaintTable();
            populateDashboard();
            if (!document.getElementById("calendar").classList.contains("hidden")) {
                initCalendar();
            }
        });

        // SEARCH
        document.getElementById("search-form").onsubmit = (e) => {
            e.preventDefault();
            const loco = e.target[0].value.trim();
            const date = e.target[1].value;
            const showAll = e.target[2].checked;
            const resultsDiv = document.getElementById("search-results");
            resultsDiv.innerHTML = "";

            const equipment = eq.find(e => e["Loco Number"] === loco);
            if (!equipment) {
                resultsDiv.innerHTML = "<p style='color: #e74c3c; font-weight: 700;'>Equipment not found.</p>";
                return;
            }

            const header = `<div style="background: rgba(13, 71, 161, 0.15); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                <strong>Equipment:</strong> ${equipment["Loco Number"]} - ${equipment.Shaft}<br>
                <strong>Level:</strong> ${equipment.Level} | <strong>Size:</strong> ${equipment["Loco Size"]} | <strong>Section:</strong> ${equipment.SECTION}
            </div>`;

            let updates = up.filter(u => u["Equipment ID"] === loco);
            if (date && !showAll) {
                updates = updates.filter(u => u.Date === date);
            }
            updates.sort((a, b) => new Date(b.Date + " " + b.Time) - new Date(a.Date + " " + a.Time));

            const updatesHTML = updates.length ? updates.map(u => `<div style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,.12);">
                <strong>${u.Date} ${u.Time}</strong> | <span style="color: ${u.Status === "Fixed" ? "#2ecc71" : "#e74c3c};">${u.Status}</span><br>
                ${u.ReasonFault} ${u["Downtime Hours"] ? `- ${u["Downtime Hours"]}h downtime` : ""}
                ${u["Is Failure?"] === 1 ? '<span class="risk-badge risk-high" style="margin-left: 8px;">FAILURE</span>' : ""}
            </div>`).join("") : "<p style='color: #f39c12;'>No updates found.</p>";

            resultsDiv.innerHTML = header + updatesHTML;
        };

        // DASHBOARD HELPERS
        function getStatus(id) {
            const updates = up.filter(u => u["Equipment ID"] === id);
            if (!updates.length) return { status: "Unknown", days: 0 };
            const latest = updates.sort((a, b) => new Date(b.Date + " " + b.Time) - new Date(a.Date + " " + a.Time))[0];
            const downUpdates = updates.filter(u => u.Status !== "Fixed");
            const lastDown = downUpdates.length ? downUpdates.sort((a, b) => new Date(b.Date + " " + b.Time) - new Date(a.Date + " " + a.Time))[0] : null;
            const days = lastDown ? Math.floor((new Date() - new Date(lastDown.Date + " " + lastDown.Time)) / 86400000) : 0;
            return { status: latest.Status === "Fixed" ? "Operational" : "Down", days };
        }

        function fillDatalist() {
            const list = document.getElementById("loco-list");
            list.innerHTML = eq.map(e => `<option value="${e["Loco Number"]}">${e["Loco Number"]} - ${e.Shaft}</option>`).join("");
            const jobSel = document.getElementById("job-loco");
            jobSel.innerHTML = `<option value="">Select Equipment</option>` + eq.map(e => `<option value="${e["Loco Number"]}">${e["Loco Number"]}</option>`).join("");
            const sf = document.getElementById("shaft-filter");
            sf.innerHTML = `<option value="">All Shafts</option>` + shafts.map(s => `<option value="${s}">${s}</option>`).join("");
            const addShaft = document.getElementById("shaft");
            addShaft.innerHTML = `<option value="">Select Shaft</option>` + shafts.map(s => `<option value="${s}">${s}</option>`).join("");
        }

        // INITIAL SETUP
        document.getElementById("m-last").value = new Date().toISOString().slice(0, 10);
        document.getElementById("u-date").value = new Date().toISOString().slice(0, 10);
        document.getElementById("s-date").value = new Date().toISOString().slice(0, 10);

        fillDatalist();
        show("dashboard");

        // POPULATE FUNCTIONS
        function populateDashboard() {
            const shaft = document.getElementById("shaft-filter").value;
            const filtered = shaft ? eq.filter(e => e.Shaft === shaft) : eq;
            const total = filtered.length;
            const operational = filtered.filter(e => getStatus(e["Loco Number"]).status === "Operational").length;
            const downShort = filtered.filter(e => getStatus(e["Loco Number"]).status === "Down" && getStatus(e["Loco Number"]).days < 7).length;
            const downLong = filtered.filter(e => getStatus(e["Loco Number"]).status === "Down" && getStatus(e["Loco Number"]).days >= 7).length;
            const avail = total ? (operational / total * 100).toFixed(1) : 0;

            document.getElementById("kpi-grid").innerHTML = `
                <div class="kpi-card green"><h2>${operational}</h2><p>Operational</p></div>
                <div class="kpi-card orange"><h2>${downShort}</h2><p>Down &lt; 7 Days</p></div>
                <div class="kpi-card red"><h2>${downLong}</h2><p>Down &gt; 7 Days</p></div>
                <div class="kpi-card" style="background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: #fff;"><h2>${avail}%</h2><p>Fleet Availability</p></div>
            `;

            const dates = filtered.flatMap(e => up.filter(u => u["Equipment ID"] === e["Loco Number"]).map(u => u.Date));
            const minD = dates.length ? dates.reduce((a, c) => c < a ? c : a) : new Date().toISOString().slice(0, 10);
            const maxD = dates.length ? dates.reduce((a, c) => c > a ? c : a) : new Date().toISOString().slice(0, 10);
            const totalDays = Math.ceil((new Date(maxD) - new Date(minD)) / 86400000) + 1;

            const availLabels = [], availData = [], failLabels = [], failData = [], mttfData = [];

            filtered.forEach(e => {
                const id = e["Loco Number"];
                const eu = up.filter(u => u["Equipment ID"] === id);
                const downH = eu.reduce((s, u) => s + (u["Downtime Hours"] || 0), 0);
                const downD = downH / 24;
                const opD = totalDays - downD;
                const failures = eu.filter(u => u["Is Failure?"] === 1).length;
                const mttf = failures > 0 ? (opD / failures).toFixed(1) : null;

                availLabels.push(id);
                availData.push(totalDays > 0 ? (opD / totalDays * 100).toFixed(1) : 0);
                failLabels.push(id);
                failData.push(failures);
                mttfData.push(mttf);
            });

            Object.values(charts).forEach(c => c.destroy());
            
            charts.avail = new Chart(document.getElementById("availabilityChart").getContext("2d"), {
                type: "bar",
                data: { labels: availLabels, datasets: [{ label: "Availability %", data: availData, backgroundColor: "#00d2d3", borderRadius: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } }
            });
            
            charts.fail = new Chart(document.getElementById("failuresChart").getContext("2d"), {
                type: "bar",
                data: { labels: failLabels, datasets: [{ label: "Failures", data: failData, backgroundColor: "#e74c3c", borderRadius: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
            
            charts.mttf = new Chart(document.getElementById("mttfChart").getContext("2d"), {
                type: "bar",
                data: { labels: availLabels, datasets: [{ label: "MTTF Days", data: mttfData, backgroundColor: "#3498db", borderRadius: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
            
            charts.delay = new Chart(document.getElementById("delayChart").getContext("2d"), {
                type: "pie",
                data: { labels: ["Awaiting Spares", "Safety"], datasets: [{ data: [8, 4], backgroundColor: ["#f39c12", "#e74c3c"] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // High-Risk
            const high = filtered.filter(e => getStatus(e["Loco Number"]).days > 7);
            document.getElementById("high-risk-list").innerHTML = high.map(e => `<li class="alert-item"><span>${e["Loco Number"]} - ${e.Shaft}</span><span class="risk-badge risk-high">CRITICAL</span></li>`).join("");
            document.getElementById("high-risk-alerts").classList.toggle("hidden", high.length === 0);

            // Upcoming Maintenance
            mt.sort((a, b) => calculateDaysLeft(a.lastDone, a.interval) - calculateDaysLeft(b.lastDone, b.interval));
            const maintList = document.getElementById("maintenance-list");
            maintList.innerHTML = mt.map(m => {
                const days = calculateDaysLeft(m.lastDone, m.interval);
                const display = isNaN(days) ? "-" : days <= 0 ? `${-days} days left` : `${days} days`;
                const color = days <= 3 ? "#2ecc71" : "#e74c3c";
                return `<div style="padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,.12); display: flex; justify-content: space-between;">
                    <span><strong>${m.equipment}</strong> - ${m.task}</span>
                    <span style="color: ${color}; font-weight: 700;">${display}</span>
                </div>`;
            }).join("");

            // Predictive
            const predictive = mt.filter(m => calculateDaysLeft(m.lastDone, m.interval) <= 7 && !isNaN(calculateDaysLeft(m.lastDone, m.interval)));
            document.getElementById("predictive-list").innerHTML = predictive.map(m => {
                const days = calculateDaysLeft(m.lastDone, m.interval);
                const label = days > 0 ? `${days} days` : "OVERDUE";
                return `<li class="alert-item"><span>${m.equipment} - ${m.task}</span><span class="risk-badge" style="background: var(--pred);">${label}</span></li>`;
            }).join("");
            document.getElementById("predictive-alerts").classList.toggle("hidden", predictive.length === 0);
        }

        function populateOperationsReport() {
            const opStatus = [
                { status: "Covered (Green)", count: 44, percentage: 93.62 },
                { status: "Within 7 Days (Orange)", count: 3, percentage: 6.38 },
                { status: "Overdue (Red)", count: 0, percentage: 0.00 },
                { status: "Total", count: 47, percentage: 100.00 }
            ];
            const problem = [
                { id: 15, status: "Down", color: "ORANGE", fault: "BRAKES", downtime: 384.0 },
                { id: 270, status: "Down", color: "ORANGE", fault: "Not Starting", downtime: 0.0 },
                { id: 155, status: "Down", color: "ORANGE", fault: "BRAKES FAILURE", downtime: 0.0 }
            ];
            const highRisk = [
                { id: 15, failures: 15, mttf: 11.33, availability: 91.40 },
                { id: 217, failures: 6, mttf: 30.00, availability: 96.77 }
            ];

            document.getElementById("op-status-tbody").innerHTML = opStatus.map(r => `<tr><td>${r.status}</td><td>${r.count}</td><td>${r.percentage.toFixed(2)}%</td></tr>`).join("");
            document.getElementById("problem-equipment-tbody").innerHTML = problem.map(r => `<tr><td>${r.id}</td><td>${r.status}</td><td style="color: #f39c12; font-weight: 700;">${r.color}</td><td>${r.fault}</td><td>${r.downtime}</td></tr>`).join("");
            document.getElementById("high-risk-tbody").innerHTML = highRisk.map(r => `<tr><td>${r.id}</td><td>${r.failures}</td><td>${r.mttf}</td><td>${r.availability}%</td></tr>`).join("");
        }

        function populateLogTable() {
            const tbody = document.querySelector("#log-table tbody");
            tbody.innerHTML = up.sort((a, b) => new Date(b.Date + " " + b.Time) - new Date(a.Date + " " + a.Time)).map(u => `<tr>
                <td>${u.Date}</td><td>${u.Time}</td><td>${u["Equipment ID"]}</td><td>${u.Status}</td>
                <td>${u.Shift}</td><td>${u.ReasonFault}</td><td>${u["Downtime Hours"] || 0}</td><td>${u["Is Failure?"] === 1 ? "Yes" : "No"}</td>
            </tr>`).join("");
        }

        function populateSummaryTable() {
            const dates = up.map(u => u.Date);
            const minD = dates.length ? dates.reduce((a, c) => c < a ? c : a) : new Date().toISOString().slice(0, 10);
            const maxD = dates.length ? dates.reduce((a, c) => c > a ? c : a) : new Date().toISOString().slice(0, 10);
            const totalDays = Math.ceil((new Date(maxD) - new Date(minD)) / 86400000) + 1;

            const tbody = document.querySelector("#summary-table tbody");
            tbody.innerHTML = eq.map(e => {
                const id = e["Loco Number"];
                const eu = up.filter(u => u["Equipment ID"] === id);
                const downH = eu.reduce((s, u) => s + (u["Downtime Hours"] || 0), 0);
                const downD = downH / 24;
                const opD = totalDays - downD;
                const failures = eu.filter(u => u["Is Failure?"] === 1).length;
                const mttf = failures > 0 ? (opD / failures).toFixed(1) : "NA";
                const avail = totalDays > 0 ? (opD / totalDays * 100).toFixed(1) : 0;
                const last = eu.sort((a, b) => new Date(b.Date + " " + b.Time) - new Date(a.Date + " " + a.Time))[0];
                const status = getStatus(id).status;

                return `<tr><td>${id}</td><td>${eu.length}</td><td>${totalDays}</td><td>${downD.toFixed(1)}</td>
                    <td>${opD.toFixed(1)}</td><td>${failures}</td><td>${mttf}</td><td>${avail}</td>
                    <td>${last ? last.Date + " " + last.Time : "-"}</td><td>${status}</td></tr>`;
            }).join("");
        }

        function populateEquipmentTable() {
            const tbody = document.querySelector("#equipment-table tbody");
            tbody.innerHTML = eq.map(e => `<tr><td>${e.Shaft}</td><td>${e.Level}</td><td>${e["Loco Size"]}</td><td>${e["Loco Number"]}</td><td>${e.SECTION}</td></tr>`).join("");
        }

        function filterDashboard() {
            populateDashboard();
        }

        // EXPORTS
        function generateJobPDF() {
            const id = document.getElementById("job-loco").value || document.getElementById("s-loco").value;
            if (!id) {
                alert("Select an Equipment ID first");
                return;
            }
            const jsPDF = window.jspdf.jsPDF;
            const doc = new jsPDF();
            let y = 16;
            doc.setFontSize(12);
            doc.text("JOB ORDER", 16, y);
            y += 12;
            doc.text("Equipment: " + id, 16, y);
            y += 8;
            doc.text("Follow correct procedure. Attach risk assessment.", 16, y);
            y += 16;
            doc.setFontSize(10);
            doc.text("Work Carried Out:", 16, y);
            y += 8;
            for (let i = 0; i < 3; i++) {
                doc.line(16, y, 190, y);
                y += 8;
            }
            y += 8;
            doc.text("Job Duration:", 16, y);
            y += 8;
            doc.autoTable({
                startY: y,
                head: ["Start Date", "Start Time", "End Date", "End Time", "Duration"],
                body: [["", "", "", "", ""]],
                theme: "grid",
                headStyles: { fillColor: [0, 128, 128] }
            });
            y = doc.lastAutoTable.finalY + 12;
            doc.text("Failure Information:", 16, y);
            y += 8;
            doc.autoTable({
                startY: y,
                head: ["Object Part", "Problem", "Cause", "Activity Carried Out"],
                body: [["", "", "", ""]],
                theme: "grid",
                headStyles: { fillColor: [0, 128, 128] }
            });
            doc.save(`JobOrder-${id}.pdf`);
        }

        function exportLogCSV() {
            let csv = "Date,Time,Equipment ID,Status,Shift,Fault,Downtime Hours,Failure\n";
            up.forEach(u => {
                csv += `"${u.Date}","${u.Time}","${u["Equipment ID"]}","${u.Status}","${u.Shift}","${u.ReasonFault}","${u["Downtime Hours"] || 0}","${u["Is Failure?"] === 1 ? "Yes" : "No"}"\n`;
            });
            const blob = new Blob([csv], { type: "text/csv" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "RBEStatusLog.csv";
            a.click();
        }

        async function exportMaintPDF() {
            const jsPDF = window.jspdf.jsPDF;
            const doc = new jsPDF();
            const rows = mt.map(m => {
                const days = calculateDaysLeft(m.lastDone, m.interval);
                const disp = isNaN(days) ? "-" : days <= 0 ? `${-days} overdue` : `${days} days`;
                return [m.equipment, m.task, m.interval, m.lastDone, calculateNextDue(m.lastDone, m.interval), disp];
            });
            doc.autoTable({
                head: [["Equipment", "Task", "Interval", "Last Done", "Due", "Days Left"]],
                body: rows,
                theme: "grid",
                headStyles: { fillColor: [13, 71, 161] }
            });
            doc.save(`MaintenanceSchedule-${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        function exportDashboardPDF() {
            const jsPDF = window.jspdf.jsPDF;
            const doc = new jsPDF("l", "mm", "a4");
            let y = 20;
            doc.setFontSize(22);
            doc.setTextColor(0, 128, 128);
            doc.text("Impala RBE Dashboard", 15, y);
            y += 15;
            doc.setFontSize(10);
            doc.setTextColor(80, 80, 80);
            doc.text("Generated " + new Date().toLocaleString(), 15, y);
            y += 20;
            doc.save(`Dashboard-${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        function exportAnalyticsPDF() {
            const jsPDF = window.jspdf.jsPDF;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text("Fleet Analytics Report", 16, 16);
            doc.setFontSize(10);
            doc.text("Generated " + new Date().toLocaleString(), 16, 28);
            doc.save(`Analytics-${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        function exportOperationsReportPDF() {
            const jsPDF = window.jspdf.jsPDF;
            const doc = new jsPDF();
            let y = 16;
            doc.setFontSize(16);
            doc.text("All Operations Report", 16, y);
            y += 12;
            doc.setFontSize(10);
            doc.text("Generated " + new Date().toLocaleString(), 16, y);
            doc.save(`OperationsReport-${new Date().toISOString().slice(0, 10)}.pdf`);
        }
    </script>
</body>
</html>
