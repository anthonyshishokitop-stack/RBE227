<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Impala RBE Monitor - Platinum Operations</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css' rel='stylesheet'>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>

  <style>
    :root{
      --bg:#0a0e17; --card:#1a2332; --txt:#e2e8f0; --border:#334155; --hdr:#1e293b;
      --prim:#0d47a1; --prim-light:#1976d2; --succ:#2ecc71; --warn:#f39c12;
      --danger:#e74c3c; --maint:#3498db; --high:#e74c3c; --pred:#e67e22;
      --shadow:0 8px 32px rgba(0,0,0,0.5); --radius:16px; --gap:28px; --pad:32px;
      --accent-gold:#f4c542; --teal:#008080;
    }
    [data-theme="light"]{
      --bg:#f8fafc; --card:#ffffff; --txt:#1e293b; --border:#cbd5e1; --hdr:#f1f5f9;
      --prim:#0d47a1; --prim-light:#1976d2; --succ:#2ecc71; --warn:#f39c12;
      --danger:#e74c3c; --maint:#3498db; --high:#e74c3c; --pred:#e67e22;
      --shadow:0 8px 32px rgba(0,0,0,0.1);
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    html,body{height:100%;font-family:'Roboto',sans-serif;background:var(--bg);color:var(--txt);overflow-x:hidden;}
    body{
      background-image:url('https://images.unsplash.com/photo-1565538810648-7f5a2c106b8f?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80');
      background-size:cover;background-position:center;background-attachment:fixed;
      display:flex;flex-direction:column;
    }
    h1,h2,h3,h4{margin:0 0 .5em;color:var(--prim);font-weight:700;}
    h1{font-size:clamp(1.9rem,4vw,2.5rem);} h2{font-size:1.6rem;}
    .wrapper{display:flex;flex:1;}
    .sidebar{position:sticky;top:0;height:100vh;width:280px;background:var(--prim);color:#fff;padding:var(--pad);box-shadow:8px 0 40px rgba(0,0,0,.25);overflow-y:auto;z-index:10;display:flex;flex-direction:column;}
    .sidebar .logo-container{text-align:center;margin-bottom:3rem;flex-shrink:0;position:relative;}
    .sidebar .logo-img{max-width:160px;display:block;margin:0 auto;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.5);}
    .theme-toggle{position:absolute;top:8px;right:8px;background:none;border:none;font-size:1.1rem;cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .3s;backdrop-filter:blur(8px);color:var(--txt);}
    .theme-toggle:hover{transform:scale(1.15);background:rgba(255,255,255,.18);}
    #sidebar-menu{list-style:none;flex:1;}
    #sidebar-menu li{padding:16px 20px;margin:10px 0;border-radius:12px;cursor:pointer;transition:all .35s ease;font-weight:600;display:flex;align-items:center;gap:16px;position:relative;overflow:hidden;}
    #sidebar-menu li[data-icon]::before{content:attr(data-icon);font-size:1.6rem;}
    #sidebar-menu li span{flex:1;font-size:1.02rem;}
    #sidebar-menu li:hover{background:var(--prim-light);transform:translateX(4px);box-shadow:0 0 20px rgba(255,255,255,.2);}
    #sidebar-menu li.active{background:var(--prim-light);box-shadow:0 0 25px rgba(255,255,255,.4);font-weight:700;transform:scale(1.03);}
    .main{flex:1;padding:var(--gap);overflow-y:auto;}
    .container{max-width:1700px;margin:0 auto;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:var(--pad);min-height:100%;position:relative;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.12);}
    .header-bar{background:linear-gradient(135deg,var(--prim),var(--prim-light));color:#fff;padding:1.4rem 2rem;border-radius:var(--radius) var(--radius) 0 0;margin:-var(--pad) -var(--pad) var(--gap);display:flex;justify-content:space-between;align-items:center;box-shadow:0 6px 25px rgba(0,0,0,.4);}
    .header-bar h1{font-size:1.9rem;text-shadow:0 2px 5px rgba(0,0,0,.5);}
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:var(--gap);margin:2.2rem 0;}
    .kpi-card{padding:2rem;border-radius:var(--radius);text-align:center;color:#fff;box-shadow:var(--shadow);font-weight:800;display:flex;flex-direction:column;gap:.6rem;position:relative;overflow:hidden;}
    .kpi-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:6px;background:linear-gradient(90deg,var(--accent-gold),transparent);}
    .kpi-card h2{font-size:2.5rem;margin:0;text-shadow:0 2px 5px rgba(0,0,0,.4);}
    .kpi-card p{font-size:1.05rem;opacity:.95;}
    .kpi-card.green{background:var(--succ);} .kpi-card.orange{background:var(--warn);color:#000;} .kpi-card.red{background:var(--danger);}
    .chart-wrapper{background:var(--card);padding:2rem;border-radius:var(--radius);box-shadow:var(--shadow);margin:2.2rem 0;position:relative;backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.15);}
    .chart-title{font-weight:700;color:var(--prim);margin-bottom:1.2rem;font-size:1.3rem;display:flex;align-items:center;gap:10px;text-shadow:0 1px 3px rgba(0,0,0,.2);}
    .alert-banner{padding:1.5rem 1.8rem;border-radius:var(--radius);margin:1.8rem 0;box-shadow:var(--shadow);border-left:8px solid;display:flex;align-items:center;gap:14px;font-weight:700;backdrop-filter:blur(8px);}
    .alert-high-risk{background:rgba(231,76,60,.18);color:var(--high);border-color:var(--high);}
    .alert-predictive{background:rgba(230,126,34,.18);color:var(--pred);border-color:var(--pred);}
    .alert-list{list-style:none;margin:1.2rem 0 0;flex:1;}
    .alert-item{background:rgba(255,255,255,.15);padding:1rem 1.4rem;margin:8px 0;border-radius:10px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 3px 8px rgba(0,0,0,.06);font-size:.98rem;border:1px solid rgba(255,255,255,.12);}
    .risk-badge{padding:7px 18px;border-radius:30px;font-size:.8rem;font-weight:900;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.5);}
    .risk-high{background:var(--high);} .risk-predict{background:var(--pred);}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem;margin:1.5rem 0;}
    .form-group{margin:0;}
    label{display:block;font-weight:700;margin-bottom:.6rem;font-size:1rem;color:var(--prim);}
    input,select,textarea{width:100%;padding:16px 18px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--txt);font-size:1.05rem;transition:all .3s;backdrop-filter:blur(5px);}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--prim);box-shadow:0 0 0 5px rgba(13,71,161,.25);}
    button{padding:16px 32px;border:none;border-radius:12px;cursor:pointer;font-weight:700;transition:all .4s;box-shadow:0 8px 22px rgba(0,0,0,.25);font-size:1.05rem;}
    button:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,.35);}
    button.primary{background:linear-gradient(135deg,var(--prim),var(--prim-light));color:#fff;}
    button.success{background:var(--succ);color:#fff;}
    button.warn{background:var(--warn);color:#000;}
    button.danger{background:var(--danger);color:#fff;}
    button.maint{background:var(--maint);color:#fff;}
    button.export{margin-left:12px;padding:12px 20px;font-size:.95rem;}
    button.teal{background:var(--teal);color:#fff;}
    button.full-width{width:100%;padding:18px;font-size:1.1rem;}
    table{width:100%;border-collapse:collapse;margin:1.8rem 0;font-size:.98rem;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);backdrop-filter:blur(8px);}
    th,td{padding:18px 16px;border-bottom:1px solid var(--border);text-align:left;}
    th{background:var(--teal);color:#fff;font-weight:700;position:sticky;top:0;z-index:5;}
    tr:nth-child(even){background:rgba(255,255,255,.04);}
    tr:hover{background:rgba(13,71,161,.1);}
    .hidden{display:none!important;}
    .live-indicator{position:fixed;bottom:1.8rem;right:1.8rem;z-index:999;display:flex;align-items:center;gap:12px;border:3px solid rgba(255,255,255,.35);border-radius:50px;padding:14px 28px;font-weight:900;box-shadow:var(--shadow);animation:pulse 2s infinite;}
    .live-indicator.connecting{background:var(--warn);color:#000;}
    .live-indicator.syncing{background:var(--maint);color:#fff;}
    .live-indicator.live{background:var(--succ);color:#fff;}
    .live-indicator::before{content:"ğŸ”„";font-size:1.2rem;}
    .live-indicator.connecting::before{content:"ğŸŸ¡";}
    .live-indicator.syncing::before{content:"â³";}
    .live-indicator.live::before{content:"ğŸŸ¢";}
    .live-indicator span{font-size:.9rem;}
    @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.07);}}
    .chart-container{position:relative;height:360px;}
    #calendar-div{background:var(--card);padding:2rem;border-radius:var(--radius);box-shadow:var(--shadow);min-height:600px;border:1px solid rgba(255,255,255,.15);}
    .maint-actions{display:flex;gap:8px;flex-wrap:wrap;}
    .maint-actions button{padding:6px 12px;font-size:.85rem;border-radius:8px;}
    .maint-actions .done-btn{background:#2ecc71;color:#fff;}
    .maint-actions .edit-btn{background:#3498db;color:#fff;}
    .maint-actions .delete-btn{background:#e74c3c;color:#fff;}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(5px);align-items:center;justify-content:center;z-index:1000;}
    .modal.active{display:flex;}
    .modal-content{background:var(--card);padding:2rem;border-radius:var(--radius);width:90%;max-width:500px;box-shadow:var(--shadow);max-height:90vh;overflow-y:auto;}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;}
    .modal-header h3{margin:0;color:var(--prim);}
    .close-modal{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--txt);}
    .upcoming-maintenance{background:linear-gradient(135deg,rgba(227,242,253,.25),rgba(187,222,251,.25));padding:2rem;border-radius:var(--radius);border-left:8px solid var(--maint);margin:2.2rem 0;box-shadow:var(--shadow);backdrop-filter:blur(10px);}
    .upcoming-maintenance h3{color:var(--maint);margin-bottom:1.4rem;font-size:1.6rem;}
    .maintenance-item{background:rgba(255,255,255,.15);padding:1rem;margin:8px 0;border-radius:10px;border:1px solid rgba(255,255,255,.12);}
    .success-message{background:var(--succ);color:#fff;padding:1.2rem;border-radius:12px;margin:1.5rem 0;font-weight:700;text-align:center;border-left:6px solid #27ae60;animation:slideIn 0.4s ease;}
    @keyframes slideIn{from{opacity:0;transform:translateX(-20px);}to{opacity:1;transform:translateX(0);}}
    @media(max-width:1200px){.sidebar{width:100px;padding:1.8rem 0;}.sidebar .logo-container,#sidebar-menu li span{display:none;}#sidebar-menu li{padding:1.4rem;text-align:center;}#sidebar-menu li[data-icon]::before{font-size:2rem;}}
    @media(max-width:768px){.wrapper{flex-direction:column;}.sidebar{width:100%;height:auto;padding:1.8rem;}.main{padding:1.4rem;}.kpi-grid{grid-template-columns:1fr;}.header-bar{flex-direction:column;gap:1.2rem;text-align:center;}.form-grid{grid-template-columns:1fr;}}
  </style>
</head>
<body data-theme="dark">

<!-- MODALS -->
<div id="edit-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Maintenance Task</h3>
      <button class="close-modal" onclick="closeEditModal()">Ã—</button>
    </div>
    <form id="edit-maint-form">
      <input type="hidden" id="edit-index">
      <div class="form-group"><label>Equipment</label><input id="edit-equipment" list="loco-list" required></div>
      <div class="form-group"><label>Task</label><input id="edit-task" type="text" required></div>
      <div class="form-group"><label>Interval</label>
        <select id="edit-interval" required>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="quarterly">Quarterly</option>
        </select>
      </div>
      <div class="form-group"><label>Last Done</label><input id="edit-last" type="date" required></div>
      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:1rem;">
        <button type="button" class="warn" onclick="closeEditModal()">Cancel</button>
        <button type="submit" class="primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<div id="add-maint-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add Maintenance Task</h3>
      <button class="close-modal" onclick="closeAddMaintModal()">Ã—</button>
    </div>
    <form id="add-maint-form">
      <div class="form-group"><label>Equipment</label><input id="add-equipment" list="loco-list" required></div>
      <div class="form-group"><label>Task</label><input id="add-task" type="text" required></div>
      <div class="form-group"><label>Interval</label>
        <select id="add-interval" required>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="quarterly">Quarterly</option>
        </select>
      </div>
      <div class="form-group"><label>Last Done</label><input id="add-last" type="date" required></div>
      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:1rem;">
        <button type="button" class="warn" onclick="closeAddMaintModal()">Cancel</button>
        <button type="submit" class="primary">Add Task</button>
      </div>
    </form>
  </div>
</div>

<div class="live-indicator live" id="live-indicator">
  <span id="live-text">LIVE â€¢ 0.0s</span>
</div>

<datalist id="loco-list"></datalist>

<div class="wrapper">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="logo-container">
      <img class="logo-img" src="https://apventures.com/wp-content/uploads/2023/06/image-35.jpeg" alt="Impala Platinum" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjYwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xMCAxMHY0MGw0MCAyMGwtNDAgMjB6IiBmaWxsPSIjMDBkNDdhMSIvPjx0ZXh0IHg9IjgwIiB5PSIzNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SU1QQUxBPC90ZXh0Pjwvc3ZnPg=='">
      <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
    </div>
    <ul id="sidebar-menu">
      <li class="active" data-section="dashboard" data-icon="ğŸ“Š"><span>Dashboard</span></li>
      <li data-section="add-equipment" data-icon="ğŸš‚"><span>Add Equipment</span></li>
      <li data-section="add-status" data-icon="ğŸ”„"><span>Status Update</span></li>
      <li data-section="search-status" data-icon="ğŸ”"><span>Search</span></li>
      <li data-section="status-log" data-icon="ğŸ“œ"><span>Full Log</span></li>
      <li data-section="summary" data-icon="ğŸ“ˆ"><span>Analytics</span></li>
      <li data-section="manage-equipment" data-icon="âš™ï¸"><span>Equipment</span></li>
      <li data-section="maintenance-schedule" data-icon="ğŸ› ï¸"><span>Maintenance</span></li>
      <li data-section="calendar" data-icon="ğŸ“…"><span>Calendar</span></li>
      <li data-section="operations-report" data-icon="ğŸ“‹"><span>Ops Report</span></li>
    </ul>
  </div>

  <div class="main">
    <div class="container">
      <!-- DASHBOARD -->
      <section id="dashboard">
        <div class="header-bar">
          <h1>ğŸ”´ LIVE PLATINUM OPERATIONS</h1>
          <div style="display:flex;gap:14px;align-items:center;">
            <select id="shaft-filter" style="padding:12px 16px;border-radius:12px;border:none;font-weight:600;background:#fff;color:#000;" onchange="filterDashboard()">
              <option value="">All Shafts</option>
            </select>
            <button class="export primary" onclick="exportDashboardPDF()">ğŸ“Š Export</button>
          </div>
        </div>

        <div id="high-risk-alerts" class="alert-banner alert-high-risk hidden">
          <strong>ğŸš¨ HIGH RISK EQUIPMENT</strong>
          <ul id="high-risk-list" class="alert-list"></ul>
        </div>

        <div id="predictive-alerts" class="alert-banner alert-predictive hidden">
          <strong>âš ï¸ PREDICTIVE MAINTENANCE</strong>
          <ul id="predictive-list" class="alert-list"></ul>
        </div>

        <div class="kpi-grid" id="kpi-grid"></div>

        <div class="chart-wrapper">
          <div class="chart-title">ğŸ“ˆ Equipment Availability</div>
          <div class="chart-container"><canvas id="availabilityChart"></canvas></div>
        </div>

        <div class="chart-wrapper">
          <div class="chart-title">ğŸ”¥ Failures by Equipment</div>
          <div class="chart-container"><canvas id="failuresChart"></canvas></div>
        </div>

        <div class="chart-wrapper">
          <div class="chart-title">â±ï¸ MTTF (Days)</div>
          <div class="chart-container"><canvas id="mttfChart"></canvas></div>
        </div>

        <div class="upcoming-maintenance" id="upcoming-maintenance">
          <h3>ğŸ”§ Upcoming Maintenance</h3>
          <div id="maintenance-list"></div>
        </div>
      </section>

      <!-- ADD EQUIPMENT - FIXED -->
      <section id="add-equipment" class="hidden">
        <div class="header-bar">
          <h1>â• Add New Equipment</h1>
          <button class="export primary" onclick="exportEquipmentCSV()">ğŸ“¥ Export Template</button>
        </div>
        <form id="add-eq-form" class="form-grid">
          <div class="form-group">
            <label>ğŸ­ Shaft <span style="color:var(--succ);font-size:0.9rem;">*</span></label>
            <select id="new-shaft" required>
              <option value="">Select Shaft</option>
              <option value="1 Shaft">1 Shaft</option>
              <option value="2 Shaft">2 Shaft</option>
              <option value="3 Shaft">3 Shaft</option>
              <option value="4 Shaft">4 Shaft</option>
              <option value="5 Shaft">5 Shaft</option>
              <option value="6 Shaft">6 Shaft</option>
              <option value="7 Shaft">7 Shaft</option>
              <option value="8 Shaft">8 Shaft</option>
              <option value="9 Shaft">9 Shaft</option>
              <option value="10 Shaft">10 Shaft</option>
              <option value="11 Shaft">11 Shaft</option>
              <option value="12 Shaft">12 Shaft</option>
              <option value="14 Shaft">14 Shaft</option>
              <option value="16 Shaft">16 Shaft</option>
              <option value="CLAPHAM">CLAPHAM</option>
              <option value="K3">K3</option>
              <option value="North Decline">North Decline</option>
              <option value="South Decline">South Decline</option>
              <option value="Apmotse">Apmotse</option>
              <option value="BPM">BPM</option>
              <option value="NPC">NPC</option>
              <option value="Leeuwkop">Leeuwkop</option>
              <option value="Zandfontein">Zandfontein</option>
              <option value="Rustenburg">Rustenburg</option>
            </select>
          </div>
          <div class="form-group">
            <label>ğŸ“ Level <span style="color:var(--succ);font-size:0.9rem;">*</span></label>
            <input id="new-level" type="text" required placeholder="e.g. 14 Level, 15 Level">
          </div>
          <div class="form-group">
            <label>ğŸš‚ Loco Size <span style="color:var(--succ);font-size:0.9rem;">*</span></label>
            <select id="new-size" required>
              <option value="">Select Size</option>
              <option value="6t Loco">6t Loco</option>
              <option value="8t Loco">8t Loco</option>
              <option value="10t Loco">10t Loco</option>
              <option value="12t Loco">12t Loco</option>
              <option value="15t Loco">15t Loco</option>
            </select>
          </div>
          <div class="form-group">
            <label>ğŸ”¢ Loco Number <span style="color:var(--succ);font-size:0.9rem;">*</span></label>
            <input id="new-number" type="text" required placeholder="e.g. 364, 217" maxlength="4">
          </div>
          <div class="form-group" style="grid-column:1/-1;">
            <label>ğŸ·ï¸ Section <span style="color:var(--succ);font-size:0.9rem;">*</span></label>
            <input id="new-section" type="text" required placeholder="e.g. 1245, 5678">
          </div>
          <div style="grid-column:1/-1;display:flex;gap:1rem;justify-content:center;">
            <button type="button" class="warn full-width" onclick="resetEquipmentForm()">ğŸ”„ Reset Form</button>
            <button type="submit" class="primary full-width">âœ… Add Equipment</button>
          </div>
        </form>
        <div id="equipment-success" class="success-message hidden">âœ… Equipment added successfully! Dashboard updated.</div>
      </section>

      <!-- STATUS UPDATE -->
      <section id="add-status" class="hidden">
        <div class="header-bar"><h1>ğŸ“ Status Update</h1></div>
        <form id="add-status-form" class="form-grid">
          <div class="form-group"><label>ğŸ“… Date</label><input id="u-date" type="date" required></div>
          <div class="form-group"><label>ğŸ•’ Time</label><input id="u-time" type="time" required></div>
          <div class="form-group"><label>ğŸš‚ Equipment ID</label><input id="u-loco" list="loco-list" required></div>
          <div class="form-group"><label>ğŸ“Š Status</label>
            <select id="u-status" required>
              <option value="Fixed">Fixed</option>
              <option value="Down">Down</option>
            </select>
          </div>
          <div class="form-group"><label>ğŸŒ™ Shift</label>
            <select id="u-shift" required>
              <option value="Morning">Morning</option>
              <option value="Afternoon">Afternoon</option>
              <option value="Night">Night</option>
            </select>
          </div>
          <div class="form-group" style="grid-column:1/-1;"><label>ğŸ”§ Reason/Fault</label><textarea id="u-reason" required placeholder="Describe the issue..."></textarea></div>
          <div class="form-group"><label>â±ï¸ Downtime Hours</label><input id="u-downtime" type="number" step="0.1" min="0" placeholder="0"></div>
          <div class="form-group"><label>âŒ Is Failure?</label>
            <select id="u-failure" required>
              <option value="0">No</option>
              <option value="1">Yes</option>
            </select>
          </div>
          <div style="grid-column:1/-1;display:flex;gap:1rem;justify-content:center;">
            <button type="reset" class="warn full-width">ğŸ”„ Reset</button>
            <button type="submit" class="primary full-width">ğŸš€ Submit Update</button>
          </div>
        </form>
      </section>

      <!-- SEARCH -->
      <section id="search-status" class="hidden">
        <div class="header-bar"><h1>ğŸ” Search Status</h1></div>
        <form id="search-form" style="display:flex;gap:14px;align-items:end;flex-wrap:wrap;max-width:800px;">
          <div class="form-group" style="min-width:200px;"><label>ğŸš‚ Equipment ID</label><input id="s-loco" list="loco-list" required></div>
          <div class="form-group" style="min-width:200px;"><label>ğŸ“… Date</label><input id="s-date" type="date"></div>
          <div class="form-group" style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="show-all-history">
            <label for="show-all-history" style="margin:0;font-weight:600;white-space:nowrap;">ğŸ“œ Full History</label>
          </div>
          <div style="display:flex;gap:12px;">
            <button type="submit" class="primary">ğŸ” Search</button>
            <button type="button" class="maint" onclick="generateJobPDF()">ğŸ“„ Job PDF</button>
          </div>
        </form>
        <div id="search-results" style="margin-top:1.8rem;"></div>
      </section>

      <!-- FULL LOG -->
      <section id="status-log" class="hidden">
        <div class="header-bar">
          <h1>ğŸ“‹ Full Status Log</h1>
          <button class="export primary" onclick="exportLogCSV()">ğŸ“¥ Export CSV</button>
        </div>
        <table id="log-table">
          <thead><tr><th>ğŸ“… Date</th><th>ğŸ•’ Time</th><th>ğŸš‚ ID</th><th>ğŸ“Š Status</th><th>ğŸŒ™ Shift</th><th>ğŸ”§ Fault</th><th>â±ï¸ Down Hrs</th><th>âŒ Failure</th></tr></thead>
          <tbody id="log-tbody"></tbody>
        </table>
      </section>

      <!-- ANALYTICS -->
      <section id="summary" class="hidden">
        <div class="header-bar">
          <h1>ğŸ“Š Fleet Analytics</h1>
          <button class="export primary" onclick="exportDashboardPDF()">ğŸ“Š Export</button>
        </div>
        <table id="summary-table">
          <thead><tr><th>ID</th><th>Updates</th><th>Total Days</th><th>Down Days</th><th>Op Days</th><th>Failures</th><th>MTTF</th><th>Avail %</th><th>Last Update</th><th>Status</th></tr></thead>
          <tbody id="summary-tbody"></tbody>
        </table>
      </section>

      <!-- EQUIPMENT LIST -->
      <section id="manage-equipment" class="hidden">
        <div class="header-bar">
          <h1>âš™ï¸ Equipment List</h1>
          <button class="export primary" onclick="exportEquipmentCSV()">ğŸ“¥ Export CSV</button>
        </div>
        <table id="equipment-table">
          <thead><tr><th>Shaft</th><th>Level</th><th>Size</th><th>Loco Number</th><th>Section</th><th>Status</th></tr></thead>
          <tbody id="equipment-tbody"></tbody>
        </table>
      </section>

      <!-- MAINTENANCE -->
      <section id="maintenance-schedule" class="hidden">
        <div class="header-bar">
          <h1>ğŸ› ï¸ Maintenance Schedule</h1>
          <div style="display:flex;gap:12px;">
            <button class="primary" onclick="openAddMaintModal()">â• Add Task</button>
            <button class="export primary" onclick="exportMaintPDF()">ğŸ“„ Export PDF</button>
          </div>
        </div>
        <table id="maint-table">
          <thead><tr><th>Equipment</th><th>Task</th><th>Interval</th><th>Last Done</th><th>Due</th><th>Days Left</th><th>Actions</th></tr></thead>
          <tbody id="maint-tbody"></tbody>
        </table>
      </section>

      <!-- CALENDAR -->
      <section id="calendar" class="hidden">
        <div class="header-bar"><h1>ğŸ“… Maintenance Calendar</h1></div>
        <div id="calendar-div"></div>
      </section>

      <!-- OPERATIONS REPORT -->
      <section id="operations-report" class="hidden">
        <div class="header-bar">
          <h1>ğŸ“‹ Operations Report</h1>
          <button class="export primary" onclick="exportOperationsReportPDF()">ğŸ“„ Export PDF</button>
        </div>
        <div style="background:var(--card);padding:2rem;border-radius:var(--radius);box-shadow:var(--shadow);margin:1.8rem 0;">
          <h2 style="color:var(--teal);">ğŸ“Š Operation Status</h2>
          <table><thead><tr><th>Status</th><th>Count</th><th>Percentage</th></tr></thead><tbody id="op-status-tbody"></tbody></table>
        </div>
        <div style="background:var(--card);padding:2rem;border-radius:var(--radius);box-shadow:var(--shadow);margin:1.8rem 0;">
          <h2 style="color:var(--teal);">ğŸ”§ Problem Equipment</h2>
          <table><thead><tr><th>ID</th><th>Status</th><th>Color</th><th>Fault</th><th>Downtime</th></tr></thead><tbody id="problem-tbody"></tbody></table>
        </div>
        <div style="background:var(--card);padding:2rem;border-radius:var(--radius);box-shadow:var(--shadow);margin:1.8rem 0;">
          <h2 style="color:var(--teal);">ğŸš¨ High Risk</h2>
          <table><thead><tr><th>ID</th><th>Failures</th><th>MTTF</th><th>Availability</th></tr></thead><tbody id="high-risk-tbody"></tbody></table>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
  // GLOBAL DATA
  let eq = [], up = [], mt = [], delaysData = [], calendar = null, charts = {};
  let syncStatus = 'live', lastSyncTime = 0;

  // COMPLETE IMPALA SHAFTS LIST
  const IMPALA_SHAFTS = [
    "1 Shaft", "2 Shaft", "3 Shaft", "4 Shaft", "5 Shaft", "6 Shaft", 
    "7 Shaft", "8 Shaft", "9 Shaft", "10 Shaft", "11 Shaft", "12 Shaft", 
    "14 Shaft", "16 Shaft", "CLAPHAM", "K3", "North Decline", "South Decline",
    "Apmotse", "BPM", "NPC", "Leeuwkop", "Zandfontein", "Rustenburg"
  ];

  // STORAGE HELPERS
  const storage = {
    get(key) { try { return JSON.parse(localStorage.getItem(key)) || []; } catch { return []; } },
    set(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
  };

  // LIVE INDICATOR
  function updateLiveIndicator() {
    const indicator = document.getElementById('live-indicator');
    const text = document.getElementById('live-text');
    const now = Date.now();
    const timeSince = ((now - lastSyncTime) / 1000).toFixed(1);
    
    indicator.className = 'live-indicator live';
    text.textContent = `LIVE â€¢ ${timeSince}s`;
  }

  // LOAD FALLBACK DATA
  function loadFallbackData() {
    eq = [
      {Shaft:"1 Shaft",Level:"14 Level","Loco Size":"10t Loco","Loco Number":"364",SECTION:"1245"},
      {Shaft:"CLAPHAM",Level:"15 Level","Loco Size":"8t Loco","Loco Number":"217",SECTION:"5678"},
      {Shaft:"North Decline",Level:"20 Level","Loco Size":"12t Loco","Loco Number":"412",SECTION:"8901"},
      {Shaft:"1 Shaft",Level:"16 Level","Loco Size":"10t Loco","Loco Number":"444",SECTION:"2234"},
      {Shaft:"1 Shaft",Level:"17 Level","Loco Size":"10t Loco","Loco Number":"155",SECTION:"3345"},
      {Shaft:"1 Shaft",Level:"18 Level","Loco Size":"10t Loco","Loco Number":"158",SECTION:"4456"},
      {Shaft:"1 Shaft",Level:"19 Level","Loco Size":"10t Loco","Loco Number":"15",SECTION:"5567"},
      {Shaft:"1 Shaft",Level:"20 Level","Loco Size":"10t Loco","Loco Number":"270",SECTION:"6678"}
    ];
    
    up = [
      {Date:"2025-11-28",Time:"07:30","Equipment ID":"364",Status:"Fixed",Shift:"Morning","Reason/Fault":"Brake pads replaced","Downtime Hours":3.5,"Is Failure?":1},
      {Date:"2025-11-27",Time:"14:20","Equipment ID":"217",Status:"Down",Shift:"Afternoon","Reason/Fault":"Hydraulic leak","Downtime Hours":8,"Is Failure?":1},
      {Date:"2025-11-28",Time:"09:00","Equipment ID":"15",Status:"Down",Shift:"Morning","Reason/Fault":"BRAKES","Downtime Hours":384,"Is Failure?":1},
      {Date:"2025-11-28",Time:"10:00","Equipment ID":"270",Status:"Down",Shift:"Morning","Reason/Fault":"Not Starting","Downtime Hours":0,"Is Failure?":1},
      {Date:"2025-11-28",Time:"11:00","Equipment ID":"155",Status:"Down",Shift:"Morning","Reason/Fault":"BRAKES FAILURE","Downtime Hours":0,"Is Failure?":1}
    ];
    
    mt = [
      {equipment:"364",task:"Oil Change",interval:"monthly",lastDone:"2025-10-28"},
      {equipment:"444",task:"Brake Inspection",interval:"weekly",lastDone:"2025-11-21"},
      {equipment:"217",task:"Service",interval:"weekly",lastDone:"2025-11-21"},
      {equipment:"155",task:"REPLACE BRAKE SHOES",interval:"weekly",lastDone:"2025-11-21"},
      {equipment:"158",task:"CHANGE OIL",interval:"weekly",lastDone:"2025-11-21"}
    ];

    // Save to localStorage
    storage.set('equipment', eq);
    storage.set('updates', up);
    storage.set('maintenance', mt);
  }

  // UTILITY FUNCTIONS
  function getStatus(id) {
    const recent = up.filter(u => u['Equipment ID'] === id)
      .sort((a,b) => new Date(b.Date + ' ' + b.Time) - new Date(a.Date + ' ' + a.Time))[0];
    return recent ? {status: recent.Status, date: recent.Date, time: recent.Time} : {status: 'Fixed', date: '-', time: '-'};
  }

  function calculateDaysLeft(lastDone, interval) {
    if (!lastDone) return NaN;
    const d = new Date(lastDone);
    if (interval === 'weekly') d.setDate(d.getDate() + 7);
    else if (interval === 'monthly') d.setMonth(d.getMonth() + 1);
    else if (interval === 'quarterly') d.setMonth(d.getMonth() + 3);
    const today = new Date(); today.setHours(0,0,0,0);
    d.setHours(0,0,0,0);
    return Math.ceil((d - today) / 86400000);
  }

  function calculateNextDue(lastDone, interval) {
    if (!lastDone) return '';
    const d = new Date(lastDone);
    if (interval === 'weekly') d.setDate(d.getDate() + 7);
    else if (interval === 'monthly') d.setMonth(d.getMonth() + 1);
    else if (interval === 'quarterly') d.setMonth(d.getMonth() + 3);
    return d.toISOString().slice(0,10);
  }

  function fillDatalist() {
    const datalist = document.getElementById('loco-list');
    datalist.innerHTML = eq.map(e => `<option value="${e['Loco Number']}">`).join('');
    
    // Fill shaft filter
    const shaftFilter = document.getElementById('shaft-filter');
    const uniqueShafts = [...new Set(eq.map(e => e.Shaft))].sort();
    shaftFilter.innerHTML = '<option value="">All Shafts</option>' + uniqueShafts.map(s => `<option value="${s}">${s}</option>`).join('');
  }

  // RESET EQUIPMENT FORM
  function resetEquipmentForm() {
    document.getElementById('add-eq-form').reset();
  }

  // SHOW SUCCESS MESSAGE
  function showSuccess(message, elementId = 'equipment-success') {
    const el = document.getElementById(elementId);
    el.textContent = message;
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 4000);
  }

  // POPULATE FUNCTIONS
  function populateDashboard() {
    // High Risk Alerts
    const highRisk = up.filter(u => u.Status === 'Down' && u['Is Failure?'] === 1)
      .reduce((acc, u) => {
        acc[u['Equipment ID']] = (acc[u['Equipment ID']] || 0) + 1;
        return acc;
      }, {});
    const highRiskList = Object.entries(highRisk)
      .sort((a,b) => b[1] - a[1])
      .slice(0,5)
      .map(([id, count]) => `<li class="alert-item"><span>${id}</span><span class="risk-badge risk-high">${count} failures</span></li>`).join('');
    
    document.getElementById('high-risk-list').innerHTML = highRiskList;
    document.getElementById('high-risk-alerts').classList.toggle('hidden', Object.keys(highRisk).length === 0);

    // Predictive Maintenance
    const predictive = mt.filter(m => {
      const days = calculateDaysLeft(m.lastDone, m.interval);
      return days <= 7 && !isNaN(days) && days >= 0;
    });
    const predictiveList = predictive.map(m => {
      const days = calculateDaysLeft(m.lastDone, m.interval);
      return `<li class="alert-item"><span>${m.equipment} - ${m.task}</span><span class="risk-badge risk-predict">${days} days</span></li>`;
    }).join('');
    
    document.getElementById('predictive-list').innerHTML = predictiveList;
    document.getElementById('predictive-alerts').classList.toggle('hidden', predictive.length === 0);

    // KPI Cards
    const operational = eq.filter(e => getStatus(e['Loco Number']).status === 'Fixed').length;
    const downShort = up.filter(u => u.Status === 'Down' && (u['Downtime Hours'] || 0) < 168).length;
    const downLong = up.filter(u => u.Status === 'Down' && (u['Downtime Hours'] || 0) >= 168).length;
    const total = eq.length;
    const availability = total > 0 ? ((operational / total) * 100).toFixed(1) : 0;

    document.getElementById('kpi-grid').innerHTML = `
      <div class="kpi-card green">
        <h2>${operational}</h2>
        <p>Operational</p>
      </div>
      <div class="kpi-card orange">
        <h2>${downShort}</h2>
        <p>Down <7 days</p>
      </div>
      <div class="kpi-card red">
        <h2>${downLong}</h2>
        <p>Down >7 days</p>
      </div>
      <div class="kpi-card" style="background:linear-gradient(135deg,#6c5ce7,#a29bfe);">
        <h2>${availability}%</h2>
        <p>Availability</p>
      </div>
    `;

    // Charts
    setTimeout(() => {
      charts.availability?.destroy();
      const ctx1 = document.getElementById('availabilityChart')?.getContext('2d');
      if (ctx1) charts.availability = new Chart(ctx1, {
        type: 'doughnut',
        data: {
          labels: ['Operational', 'Down'],
          datasets: [{data: [operational, total - operational], backgroundColor: ['#2ecc71', '#e74c3c']}]
        },
        options: {plugins: {legend: {position: 'bottom'}}}
      });

      const failureCount = eq.map(e => {
        const failures = up.filter(u => u['Equipment ID'] === e['Loco Number'] && u['Is Failure?'] === 1).length;
        return {id: e['Loco Number'], failures};
      }).filter(f => f.failures > 0).sort((a,b) => b.failures - a.failures).slice(0, 8);

      charts.failures?.destroy();
      const ctx2 = document.getElementById('failuresChart')?.getContext('2d');
      if (ctx2 && failureCount.length) charts.failures = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: failureCount.map(f => f.id),
          datasets: [{label: 'Failures', data: failureCount.map(f => f.failures), backgroundColor: '#e74c3c'}]
        },
        options: {scales: {y: {beginAtZero: true}}}
      });

      const mttfData = eq.map(e => {
        const updates = up.filter(u => u['Equipment ID'] === e['Loco Number']);
        const failures = updates.filter(u => u['Is Failure?'] === 1).length;
        const days = updates.length ? 30 : 0;
        return {id: e['Loco Number'], mttf: failures > 0 ? (days / failures).toFixed(1) : 'N/A'};
      }).filter(m => m.mttf !== 'N/A').slice(0, 8);

      charts.mttf?.destroy();
      const ctx3 = document.getElementById('mttfChart')?.getContext('2d');
      if (ctx3 && mttfData.length) charts.mttf = new Chart(ctx3, {
        type: 'bar',
        data: {
          labels: mttfData.map(m => m.id),
          datasets: [{label: 'MTTF (Days)', data: mttfData.map(m => parseFloat(m.mttf)), backgroundColor: '#f39c12'}]
        },
        options: {scales: {y: {beginAtZero: true}}}
      });
    }, 100);

    // Upcoming Maintenance
    const upcoming = mt
      .map((m, i) => ({...m, index: i, days: calculateDaysLeft(m.lastDone, m.interval)}))
      .filter(m => !isNaN(m.days) && m.days <= 14 && m.days >= 0)
      .sort((a,b) => a.days - b.days);
    
    document.getElementById('maintenance-list').innerHTML = upcoming.map(m => `
      <div class="maintenance-item">
        <strong>${m.equipment}</strong> - ${m.task}<br>
        <small>Due: ${calculateNextDue(m.lastDone, m.interval)} (${m.days} days)</small>
      </div>
    `).join('') || '<p style="color:#7f8c8d;opacity:0.7;">No upcoming maintenance</p>';
  }

  function populateLogTable() {
    const tbody = document.getElementById('log-tbody');
    const sorted = up.sort((a,b) => new Date(b.Date + ' ' + b.Time) - new Date(a.Date + ' ' + a.Time));
    tbody.innerHTML = sorted.map(u => `
      <tr>
        <td>${u.Date}</td>
        <td>${u.Time}</td>
        <td>${u['Equipment ID']}</td>
        <td style="color:${u.Status === 'Fixed' ? '#2ecc71' : '#e74c3c'}">${u.Status}</td>
        <td>${u.Shift}</td>
        <td>${u['Reason/Fault']}</td>
        <td>${u['Downtime Hours'] || 0}</td>
        <td>${u['Is Failure?'] === 1 ? 'Yes' : 'No'}</td>
      </tr>
    `).join('');
  }

  function populateSummaryTable() {
    const dates = up.map(u => u.Date);
    const minDate = dates.length ? dates.reduce((a,c) => c < a ? c : a) : new Date().toISOString().slice(0,10);
    const maxDate = dates.length ? dates.reduce((a,c) => c > a ? c : a) : new Date().toISOString().slice(0,10);
    const totalDays = Math.ceil((new Date(maxDate) - new Date(minDate)) / 86400000) + 1;

    const tbody = document.getElementById('summary-tbody');
    tbody.innerHTML = eq.map(e => {
      const id = e['Loco Number'];
      const equipmentUpdates = up.filter(u => u['Equipment ID'] === id);
      const downHours = equipmentUpdates.reduce((sum, u) => sum + (u['Downtime Hours'] || 0), 0);
      const downDays = downHours / 24;
      const opDays = totalDays - downDays;
      const failures = equipmentUpdates.filter(u => u['Is Failure?'] === 1).length;
      const mttf = failures > 0 ? (opDays / failures).toFixed(1) : 'N/A';
      const availability = totalDays > 0 ? ((opDays / totalDays) * 100).toFixed(1) : '0';
      const lastUpdate = equipmentUpdates.sort((a,b) => new Date(b.Date + ' ' + b.Time) - new Date(a.Date + ' ' + a.Time))[0];
      const status = getStatus(id).status;
      
      return `
        <tr>
          <td>${id}</td><td>${equipmentUpdates.length}</td><td>${totalDays}</td><td>${downDays.toFixed(1)}</td>
          <td>${opDays.toFixed(1)}</td><td>${failures}</td><td>${mttf}</td><td>${availability}%</td>
          <td>${lastUpdate ? `${lastUpdate.Date} ${lastUpdate.Time}` : '-'}</td>
          <td style="color:${status === 'Fixed' ? '#2ecc71' : '#e74c3c'}">${status}</td>
        </tr>
      `;
    }).join('');
  }

  function populateEquipmentTable() {
    const tbody = document.getElementById('equipment-tbody');
    tbody.innerHTML = eq.map(e => {
      const status = getStatus(e['Loco Number']).status;
      return `<tr>
        <td>${e.Shaft}</td><td>${e.Level}</td><td>${e['Loco Size']}</td>
        <td>${e['Loco Number']}</td><td>${e.SECTION}</td>
        <td style="color:${status === 'Fixed' ? '#2ecc71' : '#e74c3c'}">${status}</td>
      </tr>`;
    }).join('');
  }

  function populateMaintTable() {
    const tbody = document.getElementById('maint-tbody');
    tbody.innerHTML = mt.map((m, i) => {
      const days = calculateDaysLeft(m.lastDone, m.interval);
      const display = isNaN(days) ? '-' : (days >= 0 ? `${days} days` : `${Math.abs(days)} overdue`);
      const colorClass = days > 3 ? '' : (days > 0 ? 'warn' : 'danger');
      
      return `
        <tr>
          <td>${m.equipment}</td>
          <td>${m.task}</td>
          <td>${m.interval}</td>
          <td>${m.lastDone}</td>
          <td>${calculateNextDue(m.lastDone, m.interval)}</td>
          <td class="${colorClass}">${display}</td>
          <td class="maint-actions">
            <button class="done-btn" onclick="markDone(${i})">âœ…</button>
            <button class="edit-btn" onclick="openEditModal(${i})">âœï¸</button>
            <button class="delete-btn" onclick="deleteMaint(${i})">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  function populateOperationsReport() {
    document.getElementById('op-status-tbody').innerHTML = `
      <tr><td>Covered (Green)</td><td>5</td><td>62.5%</td></tr>
      <tr><td>Covered within 7 days (Orange)</td><td>2</td><td>25.0%</td></tr>
      <tr><td>Overdue (Red)</td><td>1</td><td>12.5%</td></tr>
      <tr style="font-weight:700;background:var(--teal);color:#fff;"><td>Total</td><td>8</td><td>100%</td></tr>
    `;

    const problems = [
      {id:'15', status:'Down', color:'ORANGE', fault:'BRAKES', downtime:384},
      {id:'270', status:'Down', color:'ORANGE', fault:'Not Starting', downtime:0},
      {id:'155', status:'Down', color:'ORANGE', fault:'BRAKES FAILURE', downtime:0}
    ];
    document.getElementById('problem-tbody').innerHTML = problems.map(p => `
      <tr><td>${p.id}</td><td>${p.status}</td><td style="color:#f39c12;">${p.color}</td><td>${p.fault}</td><td>${p.downtime}</td></tr>
    `).join('');

    const highRisk = [
      {id:'15', failures:15, mttf:'11.33', availability:'91.40%'},
      {id:'217', failures:6, mttf:'30.00', availability:'96.77%'}
    ];
    document.getElementById('high-risk-tbody').innerHTML = highRisk.map(r => `
      <tr><td>${r.id}</td><td>${r.failures}</td><td>${r.mttf}</td><td>${r.availability}</td></tr>
    `).join('');
  }

  // MODAL FUNCTIONS
  function openAddMaintModal() {
    document.getElementById('add-last').value = new Date().toISOString().slice(0,10);
    document.getElementById('add-maint-modal').classList.add('active');
  }

  function closeAddMaintModal() {
    document.getElementById('add-maint-modal').classList.remove('active');
  }

  function openEditModal(index) {
    const m = mt[index];
    document.getElementById('edit-index').value = index;
    document.getElementById('edit-equipment').value = m.equipment;
    document.getElementById('edit-task').value = m.task;
    document.getElementById('edit-interval').value = m.interval;
    document.getElementById('edit-last').value = m.lastDone;
    document.getElementById('edit-modal').classList.add('active');
  }

  function closeEditModal() {
    document.getElementById('edit-modal').classList.remove('active');
  }

  function markDone(index) {
    mt[index].lastDone = new Date().toISOString().slice(0,10);
    storage.set('maintenance', mt);
    populateMaintTable();
    populateDashboard();
  }

  function deleteMaint(index) {
    if (confirm('Delete this maintenance task?')) {
      mt.splice(index, 1);
      storage.set('maintenance', mt);
      populateMaintTable();
      populateDashboard();
    }
  }

  // CALENDAR
  function initCalendar() {
    const el = document.getElementById('calendar-div');
    if (calendar) calendar.destroy();
    
    const events = mt.map(m => ({
      title: `${m.equipment} - ${m.task}`,
      start: calculateNextDue(m.lastDone, m.interval),
      backgroundColor: calculateDaysLeft(m.lastDone, m.interval) <= 3 ? '#e74c3c' : '#3498db',
      borderColor: '#2980b9',
      textColor: '#fff'
    })).filter(e => e.start);

    calendar = new FullCalendar.Calendar(el, {
      initialView: 'dayGridMonth',
      headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
      events,
      eventDisplay: 'block',
      dayMaxEvents: true,
      height: 'auto'
    });
    calendar.render();
  }

  // NAVIGATION
  function show(section) {
    document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
    document.getElementById(section).classList.remove('hidden');
    document.querySelectorAll('#sidebar-menu li').forEach(l => l.classList.remove('active'));
    document.querySelector(`#sidebar-menu li[data-section="${section}"]`).classList.add('active');

    if (section === 'dashboard') populateDashboard();
    if (section === 'status-log') populateLogTable();
    if (section === 'summary') populateSummaryTable();
    if (section === 'manage-equipment') populateEquipmentTable();
    if (section === 'maintenance-schedule') populateMaintTable();
    if (section === 'calendar') setTimeout(initCalendar, 100);
    if (section === 'operations-report') populateOperationsReport();
  }

  // EXPORT EQUIPMENT CSV
  function exportEquipmentCSV() {
    let csv = 'Shaft,Level,Loco Size,Loco Number,Section\n';
    eq.forEach(e => {
      csv += `"${e.Shaft}","${e.Level}","${e['Loco Size']}","${e['Loco Number']}","${e.SECTION}"\n`;
    });
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Equipment_List_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
  }

  // EVENT LISTENERS
  document.addEventListener('DOMContentLoaded', () => {
    // Load data
    eq = storage.get('equipment');
    up = storage.get('updates');
    mt = storage.get('maintenance');

    if (!eq.length) loadFallbackData();

    // Fill forms
    const today = new Date().toISOString().slice(0,10);
    const now = new Date().toISOString().slice(0, 5);
    document.getElementById('u-date').value = today;
    document.getElementById('u-time').value = now;
    document.getElementById('s-date').value = today;
    if (document.getElementById('add-last')) document.getElementById('add-last').value = today;

    // Initialize
    fillDatalist();
    populateDashboard();
    populateLogTable();
    populateSummaryTable();
    populateEquipmentTable();
    populateMaintTable();
    populateOperationsReport();
    show('dashboard');

    // Theme
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.body.setAttribute('data-theme', savedTheme);
    document.getElementById('theme-toggle').textContent = savedTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';

    // Live indicator
    lastSyncTime = Date.now();
    setInterval(updateLiveIndicator, 1000);

    // ADD EQUIPMENT FORM - FIXED âœ…
    document.getElementById('add-eq-form').addEventListener('submit', e => {
      e.preventDefault();
      
      const newEquipment = {
        Shaft: document.getElementById('new-shaft').value,
        Level: document.getElementById('new-level').value,
        'Loco Size': document.getElementById('new-size').value,
        'Loco Number': document.getElementById('new-number').value.trim(),
        SECTION: document.getElementById('new-section').value
      };

      // Check for duplicate loco number
      const duplicate = eq.find(eq => eq['Loco Number'] === newEquipment['Loco Number']);
      if (duplicate) {
        alert(`âš ï¸ Loco ${newEquipment['Loco Number']} already exists!`);
        return;
      }

      // Add to equipment list
      eq.push(newEquipment);
      storage.set('equipment', eq);
      
      // Update everything
      fillDatalist();
      populateDashboard();
      populateEquipmentTable();
      populateSummaryTable();
      
      // Reset form and show success
      e.target.reset();
      showSuccess('âœ… Equipment added successfully! Dashboard updated.');
      
      console.log('âœ… New Equipment Added:', newEquipment);
    });

    // STATUS UPDATE FORM
    document.getElementById('add-status-form').addEventListener('submit', e => {
      e.preventDefault();
      up.push({
        Date: document.getElementById('u-date').value,
        Time: document.getElementById('u-time').value,
        'Equipment ID': document.getElementById('u-loco').value,
        Status: document.getElementById('u-status').value,
        Shift: document.getElementById('u-shift').value,
        'Reason/Fault': document.getElementById('u-reason').value,
        'Downtime Hours': parseFloat(document.getElementById('u-downtime').value) || 0,
        'Is Failure?': parseInt(document.getElementById('u-failure').value)
      });
      storage.set('updates', up);
      populateDashboard();
      populateLogTable();
      populateSummaryTable();
      e.target.reset();
      document.getElementById('u-date').value = today;
      document.getElementById('u-time').value = now;
      alert('âœ… Status update saved!');
    });

    // MAINTENANCE FORMS
    document.getElementById('add-maint-form').addEventListener('submit', e => {
      e.preventDefault();
      mt.push({
        equipment: document.getElementById('add-equipment').value,
        task: document.getElementById('add-task').value,
        interval: document.getElementById('add-interval').value,
        lastDone: document.getElementById('add-last').value
      });
      storage.set('maintenance', mt);
      closeAddMaintModal();
      populateMaintTable();
      populateDashboard();
      e.target.reset();
      alert('âœ… Maintenance task added!');
    });

    document.getElementById('edit-maint-form').addEventListener('submit', e => {
      e.preventDefault();
      const index = parseInt(document.getElementById('edit-index').value);
      mt[index] = {
        equipment: document.getElementById('edit-equipment').value,
        task: document.getElementById('edit-task').value,
        interval: document.getElementById('edit-interval').value,
        lastDone: document.getElementById('edit-last').value
      };
      storage.set('maintenance', mt);
      closeEditModal();
      populateMaintTable();
      populateDashboard();
      alert('âœ… Task updated!');
    });

    // SEARCH FORM
    document.getElementById('search-form').addEventListener('submit', e => {
      e.preventDefault();
      const loco = document.getElementById('s-loco').value;
      const date = document.getElementById('s-date').value;
      const showAll = document.getElementById('show-all-history').checked;
      
      if (!loco) return alert('Please enter Equipment ID');
      
      const equipment = eq.find(e => e['Loco Number'] === loco);
      if (!equipment) return alert('Equipment not found');
      
      let updates = up.filter(u => u['Equipment ID'] === loco);
      if (date && !showAll) updates = updates.filter(u => u.Date === date);
      
      updates.sort((a,b) => new Date(b.Date + ' ' + b.Time) - new Date(a.Date + ' ' + a.Time));
      
      const header = `
        <div style="background:linear-gradient(135deg,rgba(13,71,161,0.2),rgba(25,118,210,0.2));padding:1.5rem;border-radius:12px;margin-bottom:1.5rem;border-left:6px solid var(--prim);">
          <h3 style="margin:0 0 0.5rem 0;color:var(--prim);">ğŸš‚ ${equipment['Loco Number']}</h3>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;font-size:0.95rem;">
            <div><strong>Shaft:</strong> ${equipment.Shaft}</div>
            <div><strong>Level:</strong> ${equipment.Level}</div>
            <div><strong>Size:</strong> ${equipment['Loco Size']}</div>
            <div><strong>Section:</strong> ${equipment.SECTION}</div>
          </div>
        </div>
      `;
      
      const results = updates.length ? updates.map(u => `
        <div style="background:rgba(255,255,255,0.1);padding:1.2rem;margin:0.8rem 0;border-radius:12px;border-left:4px solid ${u.Status === 'Fixed' ? '#2ecc71' : '#e74c3c'};">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <strong>${u.Date} ${u.Time}</strong><br>
              <span style="color:${u.Status === 'Fixed' ? '#2ecc71' : '#e74c3c'};font-weight:700;">${u.Status}</span>
              â€¢ ${u.Shift} Shift
            </div>
            <div style="text-align:right;">
              <div><strong>${u['Reason/Fault']}</strong></div>
              ${u['Downtime Hours'] ? `<div>${u['Downtime Hours']} hours downtime</div>` : ''}
              ${u['Is Failure?'] === 1 ? '<span class="risk-badge risk-high" style="margin-top:4px;">FAILURE</span>' : ''}
            </div>
          </div>
        </div>
      `).join('') : `
        <div style="text-align:center;padding:3rem;background:rgba(255,255,255,0.05);border-radius:12px;color:#95a5a6;">
          <h3>â„¹ï¸ No Status Updates</h3>
          <p>This equipment has no recorded status updates yet.</p>
        </div>
      `;
      
      document.getElementById('search-results').innerHTML = header + results;
    });

    // Navigation
    document.querySelectorAll('#sidebar-menu li').forEach(li => {
      li.addEventListener('click', () => show(li.dataset.section));
    });

    // Theme toggle
    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
  });

  function toggleTheme() {
    const current = document.body.getAttribute('data-theme');
    const newTheme = current === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    document.getElementById('theme-toggle').textContent = newTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
  }

  // EXPORT FUNCTIONS (keeping existing ones)
  function generateJobPDF() {
    const loco = document.getElementById('s-loco')?.value || prompt('Enter Equipment ID:');
    if (!loco) return alert('Please enter Equipment ID');
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;
    
    doc.setFontSize(20); doc.setTextColor(0,128,128);
    doc.text(`JOB ORDER - LOCO ${loco}`, 20, y); y += 15;
    
    doc.setFontSize(12); doc.setTextColor(50);
    doc.text(`Generated: ${new Date().toLocaleString('en-ZA')}`, 20, y); y += 10;
    
    doc.text('Work carried out / comments:', 20, y); y += 8;
    for (let i = 0; i < 3; i++) { doc.line(20, y, 190, y); y += 8; }
    
    doc.text('Job duration:', 20, y); y += 10;
    doc.text('Start: ______   End: ______   Duration: ______', 20, y); y += 15;
    
    doc.autoTable({
      startY: y,
      head: [['Part', 'Problem', 'Cause', 'Action']],
      body: [['', '', '', '']],
      theme: 'grid',
      headStyles: {fillColor: [0,128,128]}
    });
    y = doc.lastAutoTable.finalY + 15;
    
    doc.text("Five Why's Analysis:", 20, y); y += 10;
    doc.autoTable({
      startY: y,
      head: [['Why 1', 'Why 2', 'Why 3', 'Why 4', 'Why 5']],
      body: [['', '', '', '', '']],
      theme: 'grid',
      headStyles: {fillColor: [0,128,128]}
    });
    
    doc.save(`Job_Order_${loco}.pdf`);
  }

  function exportLogCSV() {
    let csv = 'Date,Time,Equipment ID,Status,Shift,Reason/Fault,Downtime Hours,Is Failure?\n';
    up.forEach(u => {
      csv += `"${u.Date}","${u.Time}","${u['Equipment ID']}","${u.Status}","${u.Shift}","${u['Reason/Fault']}",${u['Downtime Hours'] || 0},${u['Is Failure?'] === 1 ? 'Yes' : 'No'}\n`;
    });
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `RBE_Log_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
  }

  // Other export functions remain the same...
  async function exportMaintPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const rows = mt.map(m => {
      const days = calculateDaysLeft(m.lastDone, m.interval);
      const display = isNaN(days) ? '-' : (days >= 0 ? days : `-${Math.abs(days)}`);
      return [m.equipment, m.task, m.interval, m.lastDone, calculateNextDue(m.lastDone, m.interval), display];
    });
    
    doc.autoTable({
      head: [['Equipment', 'Task', 'Interval', 'Last Done', 'Due', 'Days Left']],
      body: rows,
      theme: 'grid',
      headStyles: {fillColor: [13,71,161]}
    });
    doc.save(`Maintenance_${new Date().toISOString().slice(0,10)}.pdf`);
  }

  function filterDashboard() {
    populateDashboard();
  }

  // Placeholder for other exports
  function exportDashboardPDF() { alert('ğŸ“Š Dashboard PDF export coming soon!'); }
  function exportOperationsReportPDF() { alert('ğŸ“„ Operations Report PDF export coming soon!'); }
</script>
</body>
</html>