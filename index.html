<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Impala RBE Monitor - Platinum Operations</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css' rel='stylesheet' />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>

  <style>
    :root{
      --bg:#0a0e17; --card:#1a2332; --txt:#e2e8f0; --border:#334155; --hdr:#1e293b;
      --prim:#0d47a1; --prim-light:#1976d2; --succ:#2ecc71; --warn:#f39c12;
      --danger:#e74c3c; --maint:#3498db; --high:#e74c3c; --pred:#e67e22;
      --shadow:0 8px 32px rgba(0,0,0,0.5); --radius:16px; --gap:28px; --pad:32px;
      --accent-gold:#f4c542; --teal:#008080;
    }
    [data-theme="light"]{
      --bg:#f8fafc; --card:#ffffff; --txt:#1e293b; --border:#cbd5e1; --hdr:#f1f5f9;
      --prim:#0d47a1; --prim-light:#1976d2; --succ:#2ecc71; --warn:#f39c12;
      --danger:#e74c3c; --maint:#3498db; --high:#e74c3c; --pred:#e67e22;
      --shadow:0 8px 32px rgba(0,0,0,0.1);
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    html,body{height:100%;font-family:'Roboto',sans-serif;background:var(--bg);color:var(--txt);overflow-x:hidden;}
    body{
      background-image:url('https://images.unsplash.com/photo-1565538810648-7f5a2c106b8f?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80');
      background-size:cover;background-position:center;background-attachment:fixed;
      display:flex;flex-direction:column;
    }
    h1,h2,h3,h4{margin:0 0 .5em;color:var(--prim);font-weight:700;}
    h1{font-size:clamp(1.9rem,4vw,2.5rem);} h2{font-size:1.6rem;}
    .wrapper{display:flex;flex:1;}
    .sidebar{position:sticky;top:0;height:100vh;width:280px;background:var(--prim);color:#fff;padding:var(--pad);box-shadow:8px 0 40px rgba(0,0,0,.25);overflow-y:auto;z-index:10;display:flex;flex-direction:column;}
    .sidebar .logo-container{text-align:center;margin-bottom:3rem;flex-shrink:0;position:relative;}
    .sidebar .logo-img{max-width:160px;display:block;margin:0 auto;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.5);}
    .theme-toggle{position:absolute;top:8px;right:8px;background:none;border:none;font-size:1.1rem;cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .3s;backdrop-filter:blur(8px);color:var(--txt);}
    .theme-toggle:hover{transform:scale(1.15);background:rgba(255,255,255,.18);}
    #sidebar-menu{list-style:none;flex:1;}
    #sidebar-menu li{padding:16px 20px;margin:10px 0;border-radius:12px;cursor:pointer;transition:all .35s ease;font-weight:600;display:flex;align-items:center;gap:16px;position:relative;overflow:hidden;}
    #sidebar-menu li[data-icon]::before{content:attr(data-icon);font-size:1.6rem;}
    #sidebar-menu li span{flex:1;font-size:1.02rem;}
    #sidebar-menu li:hover{background:var(--prim-light);transform:translateX(4px);box-shadow:0 0 20px rgba(255,255,255,.2);}
    #sidebar-menu li.active{background:var(--prim-light);box-shadow:0 0 25px rgba(255,255,255,.4);font-weight:700;transform:scale(1.03);}
    .main{flex:1;padding:var(--gap);overflow-y:auto;}
    .container{max-width:1700px;margin:0 auto;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:var(--pad);min-height:100%;position:relative;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.12);}
    .header-bar{background:linear-gradient(135deg,var(--prim),var(--prim-light));color:#fff;padding:1.4rem 2rem;border-radius:var(--radius) var(--radius) 0 0;margin:-var(--pad) -var(--pad) var(--gap);display:flex;justify-content:space-between;align-items:center;box-shadow:0 6px 25px rgba(0,0,0,.4);}
    .header-bar h1{font-size:1.9rem;text-shadow:0 2px 5px rgba(0,0,0,.5);}
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:var(--gap);margin:2.2rem 0;}
    .kpi-card{padding:2rem;border-radius:var(--radius);text-align:center;color:#fff;box-shadow:var(--shadow);font-weight:800;display:flex;flex-direction:column;gap:.6rem;position:relative;overflow:hidden;}
    .kpi-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:6px;background:linear-gradient(90deg,var(--accent-gold),transparent);}
    .kpi-card h2{font-size:2.5rem;margin:0;text-shadow:0 2px 5px rgba(0,0,0,.4);}
    .kpi-card p{font-size:1.05rem;opacity:.95;}
    .kpi-card.green::before{background:var(--succ);}
    .kpi-card.orange::before{background:var(--warn);}
    .kpi-card.red::before{background:var(--danger);}
    .chart-wrapper{background:var(--card);padding:2rem;border-radius:var(--radius);box-shadow:var(--shadow);margin:2.2rem 0;position:relative;backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.15);}
    .chart-title{font-weight:700;color:var(--prim);margin-bottom:1.2rem;font-size:1.3rem;display:flex;align-items:center;gap:10px;text-shadow:0 1px 3px rgba(0,0,0,.2);}
    .alert-banner{padding:1.5rem 1.8rem;border-radius:var(--radius);margin:1.8rem 0;box-shadow:var(--shadow);border-left:8px solid;display:flex;align-items:center;gap:14px;font-weight:700;backdrop-filter:blur(8px);}
    .alert-high-risk{background:rgba(231,76,60,.18);color:var(--high);border-color:var(--high);}
    .alert-predictive{background:rgba(230,126,34,.18);color:var(--pred);border-color:var(--pred);}
    .alert-list{list-style:none;margin:1.2rem 0 0;flex:1;}
    .alert-item{background:rgba(255,255,255,.15);padding:1rem 1.4rem;margin:8px 0;border-radius:10px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 3px 8px rgba(0,0,0,.06);font-size:.98rem;border:1px solid rgba(255,255,255,.12);}
    .risk-badge{padding:7px 18px;border-radius:30px;font-size:.8rem;font-weight:900;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.5);}
    .risk-high{background:var(--high);}
    .risk-predict{background:var(--pred);}
    .form-group{margin:1.4rem 0;}
    label{display:block;font-weight:700;margin-bottom:.6rem;font-size:1rem;color:var(--prim);}
    input,select,textarea{width:100%;padding:16px 18px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--txt);font-size:1.05rem;transition:all .3s;backdrop-filter:blur(5px);}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--prim);box-shadow:0 0 0 5px rgba(13,71,161,.25);}
    button{padding:16px 32px;border:none;border-radius:12px;cursor:pointer;font-weight:700;transition:all .4s;box-shadow:0 8px 22px rgba(0,0,0,.25);font-size:1.05rem;}
    button:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,.35);}
    button.primary{background:linear-gradient(135deg,var(--prim),var(--prim-light));color:#fff;}
    button.success{background:var(--succ);color:#fff;}
    button.warn{background:var(--warn);color:#000;}
    button.danger{background:var(--danger);color:#fff;}
    button.maint{background:var(--maint);color:#fff;}
    button.export{margin-left:12px;padding:12px 20px;font-size:.95rem;}
    button.teal{background:var(--teal);color:#fff;}
    table{width:100%;border-collapse:collapse;margin:1.8rem 0;font-size:.98rem;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);backdrop-filter:blur(8px);}
    th,td{padding:18px 16px;border-bottom:1px solid var(--border);text-align:left;}
    th{background:var(--teal);color:#fff;font-weight:700;position:sticky;top:0;z-index:5;}
    tr:nth-child(even){background:rgba(255,255,255,.04);}
    tr:hover{background:rgba(13,71,161,.1);}
    .hidden{display:none!important;}
    .live-indicator{position:fixed;bottom:1.8rem;right:1.8rem;z-index:999;display:flex;align-items:center;gap:12px;border:3px solid rgba(255,255,255,.35);border-radius:50px;padding:14px 28px;font-weight:900;box-shadow:var(--shadow);animation:pulse 2s infinite;}
    .live-indicator.connecting{background:var(--warn);color:#000;}
    .live-indicator.syncing{background:var(--maint);color:#fff;}
    .live-indicator.live{background:var(--succ);color:#fff;}
    .live-indicator::before{content:"üîÑ";font-size:1.2rem;}
    .live-indicator.connecting::before{content:"üü°";}
    .live-indicator.syncing::before{content:"‚è≥";}
    .live-indicator.live::before{content:"üü¢";}
    .live-indicator span{font-size:.9rem;}
    @keyframes pulse{0%,100%{transform:scale(1);}50%{transform:scale(1.07);}}
    .chart-container{position:relative;height:360px;}
    #calendar-div{background:var(--card);padding:2rem;border-radius:var(--radius);box-shadow:var(--shadow);min-height:600px;border:1px solid rgba(255,255,255,.15);}
    .maint-actions{display:flex;gap:8px;}
    .maint-actions button{padding:6px 12px;font-size:.85rem;border-radius:8px;}
    .maint-actions .done-btn{background:#2ecc71;color:#fff;}
    .maint-actions .edit-btn{background:#3498db;color:#fff;}
    .maint-actions .delete-btn{background:#e74c3c;color:#fff;}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(5px);align-items:center;justify-content:center;z-index:1000;}
    .modal.active{display:flex;}
    .modal-content{background:var(--card);padding:2rem;border-radius:var(--radius);width:90%;max-width:500px;box-shadow:var(--shadow);}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;}
    .modal-header h3{margin:0;color:var(--prim);}
    .close-modal{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--txt);}
    .job-order-preview{background:var(--card);padding:2rem;border-radius:var(--radius);box-shadow:var(--shadow);margin:1.8rem 0;}
    .job-order-preview h2{color:var(--teal);margin-bottom:1rem;}
    .job-line{border-bottom:1px solid var(--border);margin:12px 0;}
    .job-table{margin:1.5rem 0;}
    .job-table th{background:var(--teal);color:#fff;padding:10px;}
    .job-table td{padding:10px;border:1px solid var(--border);}
    .signature-line{display:flex;gap:2rem;margin-top:2rem;}
    .signature-line div{flex:1;}
    @media(max-width:1200px){.sidebar{width:100px;padding:1.8rem 0;}.sidebar .logo-container,#sidebar-menu li span{display:none;}#sidebar-menu li{padding:1.4rem;text-align:center;}#sidebar-menu li[data-icon]::before{font-size:2rem;}}
    @media(max-width:768px){.wrapper{flex-direction:column;}.sidebar{width:100%;height:auto;padding:1.8rem;}.main{padding:1.4rem;}.kpi-grid{grid-template-columns:1fr;}.header-bar{flex-direction:column;gap:1.2rem;text-align:center;}}
  </style>
</head>
<body data-theme="dark">

<!-- ==== MODALS ==== -->
<div id="edit-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3>Edit Maintenance Task</h3><button class="close-modal" onclick="closeEditModal()">√ó</button></div>
    <form id="edit-maint-form">
      <input type="hidden" id="edit-index">
      <div class="form-group"><label>Equipment</label><input id="edit-equipment" list="loco-list" required></div>
      <div class="form-group"><label>Task</label><input id="edit-task" type="text" required></div>
      <div class="form-group"><label>Interval</label>
        <select id="edit-interval" required><option>weekly</option><option>monthly</option><option>quarterly</option></select>
      </div>
      <div class="form-group"><label>Last Done</label><input id="edit-last" type="date" required></div>
      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:1rem;">
        <button type="button" class="warn" onclick="closeEditModal()">Cancel</button>
        <button type="submit" class="primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<div id="add-maint-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3>Add Maintenance Task</h3><button class="close-modal" onclick="closeAddMaintModal()">√ó</button></div>
    <form id="add-maint-form">
      <div class="form-group"><label>Equipment</label><input list="loco-list" required></div>
      <div class="form-group"><label>Task</label><input type="text" required></div>
      <div class="form-group"><label>Interval</label>
        <select required><option>weekly</option><option>monthly</option><option>quarterly</option></select>
      </div>
      <div class="form-group"><label>Last Done</label><input type="date" id="m-last" required></div>
      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:1rem;">
        <button type="button" class="warn" onclick="closeAddMaintModal()">Cancel</button>
        <button type="submit" class="primary">Add Task</button>
      </div>
    </form>
  </div>
</div>

<div class="live-indicator connecting" id="live-indicator">
  <span id="live-text">Connecting...</span>
</div>

<datalist id="loco-list"></datalist>

<div class="wrapper">
  <div class="sidebar">
    <div class="logo-container">
      <img class="logo-img" src="https://apventures.com/wp-content/uploads/2023/06/image-35.jpeg" alt="Impala Platinum Logo">
      <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()">üåô</button>
    </div>
    <ul id="sidebar-menu">
      <li class="active" data-section="dashboard" data-icon="üìä"><span>Dashboard</span></li>
      <li data-section="add-equipment" data-icon="üöÇ"><span>+ Equipment</span></li>
      <li data-section="add-status" data-icon="üîÑ"><span>Status Update</span></li>
      <li data-section="search-status" data-icon="üîç"><span>Search</span></li>
      <li data-section="status-log" data-icon="üìú"><span>Full Log</span></li>
      <li data-section="summary" data-icon="üìà"><span>Analytics</span></li>
      <li data-section="manage-equipment" data-icon="‚öôÔ∏è"><span>Equipment List</span></li>
      <li data-section="maintenance-schedule" data-icon="üõ†Ô∏è"><span>Maintenance</span></li>
      <li data-section="calendar" data-icon="üìÖ"><span>Calendar</span></li>
      <li data-section="operations-report" data-icon="üìã"><span>Ops Report</span></li>
    </ul>
  </div>

  <div class="main">
    <div class="container">
      <!-- DASHBOARD -->
      <section id="dashboard">
        <div class="header-bar">
          <h1>üî¥ LIVE PLATINUM OPERATIONS</h1>
          <div style="display:flex;gap:14px;align-items:center;">
            <select id="shaft-filter" style="padding:12px 16px;border-radius:12px;border:none;font-weight:600;background:#fff;color:#000;" onchange="filterDashboard()"></select>
            <button class="export primary" onclick="exportDashboardPDF()">üìä Export Dashboard</button>
          </div>
        </div>

        <div id="high-risk-alerts" class="alert-banner alert-high-risk hidden">
          <strong>üö® HIGH RISK EQUIPMENT</strong>
          <ul id="high-risk-list" class="alert-list"></ul>
        </div>

        <div id="predictive-alerts" class="alert-banner alert-predictive hidden">
          <strong>‚ö†Ô∏è PREDICTIVE MAINTENANCE</strong>
          <ul id="predictive-list" class="alert-list"></ul>
        </div>

        <div class="kpi-grid" id="kpi-grid"></div>

        <div class="chart-wrapper">
          <div class="chart-title">üìà Equipment Availability (%)</div>
          <div class="chart-container"><canvas id="availabilityChart"></canvas></div>
        </div>

        <div class="chart-wrapper">
          <div class="chart-title">üî• Failure Count by Equipment</div>
          <div class="chart-container"><canvas id="failuresChart"></canvas></div>
        </div>

        <div class="chart-wrapper">
          <div class="chart-title">‚è±Ô∏è MTTF (Mean Time To Failure) - Days</div>
          <div class="chart-container"><canvas id="mttfChart"></canvas></div>
        </div>

        <div class="chart-wrapper">
          <div class="chart-title">‚è≥ Delay Reasons (This Week)</div>
          <div class="chart-container"><canvas id="delayChart"></canvas></div>
        </div>

        <div class="upcoming-maintenance" id="upcoming-maintenance" style="background:linear-gradient(135deg,rgba(227,242,253,.25),rgba(187,222,251,.25));padding:2rem;border-radius:var(--radius);border-left:8px solid var(--maint);margin-top:2.2rem;box-shadow:var(--shadow);backdrop-filter:blur(10px);">
          <h3 style="color:var(--maint);margin-bottom:1.4rem;font-size:1.6rem;">üîß Upcoming Maintenance</h3>
          <div id="maintenance-list"></div>
        </div>
      </section>

      <!-- ADD EQUIPMENT -->
      <section id="add-equipment" class="hidden">
        <div class="header-bar"><h1>‚ûï Add New Equipment</h1></div>
        <form id="add-eq-form" style="max-width:600px;">
          <div class="form-group"><label>Shaft</label><select id="shaft" required><option value="">Select Shaft</option></select></div>
          <div class="form-group"><label>Level</label><input id="level" type="text" required></div>
          <div class="form-group"><label>Loco Size</label><input id="loco-size" type="text" required></div>
          <div class="form-group"><label>Loco Number</label><input id="loco-number" type="text" required></div>
          <div class="form-group"><label>SECTION</label><input id="section" type="text" required></div>
          <button type="submit" class="primary">‚úÖ Add Equipment</button>
        </form>
      </section>

      <!-- STATUS UPDATE -->
      <section id="add-status" class="hidden">
        <div class="header-bar"><h1>üìù Status Update</h1></div>
        <form id="add-status-form" style="max-width:600px;">
          <div class="form-group"><label>üìÖ Date</label><input id="u-date" type="date" required></div>
          <div class="form-group"><label>üïí Time</label><input id="u-time" type="time" required></div>
          <div class="form-group"><label>üöÇ Equipment ID</label><input id="u-loco" list="loco-list" required></div>
          <div class="form-group"><label>üìä Status</label><select id="u-status"><option>Fixed</option><option>Down</option></select></div>
          <div class="form-group"><label>üåô Shift</label><select id="u-shift"><option>Morning</option><option>Afternoon</option><option>Night</option></select></div>
          <div class="form-group"><label>üîß Reason/Fault</label><textarea id="u-reason" required></textarea></div>
          <div class="form-group"><label>‚è±Ô∏è Downtime Hours</label><input id="u-downtime" type="number" step="0.1" min="0"></div>
          <div class="form-group"><label>‚ùå Is Failure?</label><select id="u-failure"><option value="0">No</option><option value="1">Yes</option></select></div>
          <button type="submit" class="primary">üöÄ Submit Update</button>
        </form>
      </section>

      <!-- SEARCH -->
      <section id="search-status" class="hidden">
        <div class="header-bar"><h1>üîç Search Status</h1></div>
        <form id="search-form" style="display:flex;gap:14px;align-items:end;flex-wrap:wrap;max-width:800px;">
          <div class="form-group"><label>üöÇ Equipment ID</label><input id="s-loco" list="loco-list"></div>
          <div class="form-group"><label>üìÖ Date</label><input id="s-date" type="date"></div>
          <div class="form-group"><label>üìã Job Order</label><select id="job-loco"><option value="">Select Equipment</option></select></div>
          <div class="form-group" style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="show-all-history">
            <label for="show-all-history" style="margin:0;font-weight:600;white-space:nowrap;">üìú Full History</label>
          </div>
          <button type="submit" class="primary">üîç Search</button>
          <button type="button" class="maint" onclick="generateJobPDF()">üìÑ Job Order PDF</button>
        </form>
        <div id="search-results" style="margin-top:1.8rem;"></div>
      </section>

      <!-- FULL LOG -->
      <section id="status-log" class="hidden">
        <div class="header-bar">
          <h1>üìã Full Status Log</h1>
          <button class="export primary" onclick="exportLogCSV()">üì• Export CSV</button>
        </div>
        <table id="log-table" style="margin-top:1.8rem;">
          <thead><tr><th>üìÖ Date</th><th>üïí Time</th><th>üöÇ ID</th><th>üìä Status</th><th>üåô Shift</th><th>üîß Fault</th><th>‚è±Ô∏è Down Hrs</th><th>‚ùå Failure</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- ANALYTICS -->
      <section id="summary" class="hidden">
        <div class="header-bar">
          <h1>üìä Fleet Analytics</h1>
          <button class="export primary" onclick="exportDashboardPDF()">üìä Export Report</button>
        </div>
        <table id="summary-table" style="margin-top:1.8rem;">
          <thead><tr><th>ID</th><th>Updates</th><th>Total Days</th><th>Down Days</th><th>Op Days</th><th>Failures</th><th>MTTF</th><th>Avail %</th><th>Last Update</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- EQUIPMENT LIST -->
      <section id="manage-equipment" class="hidden">
        <div class="header-bar"><h1>‚öôÔ∏è Equipment List</h1></div>
        <table id="equipment-table">
          <thead><tr><th>Shaft</th><th>Level</th><th>Size</th><th>Loco Number</th><th>Section</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- MAINTENANCE SCHEDULE -->
      <section id="maintenance-schedule" class="hidden">
        <div class="header-bar">
          <h1>üõ†Ô∏è Maintenance Schedule</h1>
          <div>
            <button class="primary" onclick="document.getElementById('add-maint-modal').classList.add('active')">‚ûï Add Task</button>
            <button class="export primary" onclick="exportMaintPDF()">üìÑ Export PDF</button>
          </div>
        </div>
        <table id="maint-table">
          <thead>
            <tr>
              <th>Equipment</th><th>Task</th><th>Interval</th><th>Last Done</th><th>Due</th><th>Days Left</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- CALENDAR -->
      <section id="calendar" class="hidden">
        <div class="header-bar"><h1>üìÖ Maintenance Calendar</h1></div>
        <div id="calendar-div"></div>
      </section>

      <!-- OPERATIONS REPORT -->
      <section id="operations-report" class="hidden">
        <div class="header-bar">
          <h1>üìã Operations Report</h1>
          <button class="export primary" onclick="exportOperationsReportPDF()">üìÑ Export PDF</button>
        </div>
        <div style="background:var(--card);padding:2rem;border-radius:var(--radius);box-shadow:var(--shadow);margin:1.8rem 0;">
          <h2 style="color:var(--teal);margin-bottom:1rem;">üìä Operation Status</h2>
          <table style="width:100%;">
            <thead><tr><th>Status</th><th>Count</th><th>Percentage</th></tr></thead>
            <tbody id="op-status-tbody"></tbody>
          </table>
        </div>
        <div style="background:var(--card);padding:2rem;border-radius:var(--radius);box-shadow:var(--shadow);margin:1.8rem 0;">
          <h2 style="color:var(--teal);margin-bottom:1rem;">üîß Problem Equipment</h2>
          <table style="width:100%;">
            <thead><tr><th>Equipment ID</th><th>Status</th><th>Color</th><th>Last Fault</th><th>Total Downtime</th></tr></thead>
            <tbody id="problem-equipment-tbody"></tbody>
          </table>
        </div>
        <div style="background:var(--card);padding:2rem;border-radius:var(--radius);box-shadow:var(--shadow);margin:1.8rem 0;">
          <h2 style="color:var(--teal);margin-bottom:1rem;">üö® High Risk Equipment</h2>
          <table style="width:100%;">
            <thead><tr><th>Equipment ID</th><th>Failures</th><th>MTTF (Days)</th><th>Availability %</th></tr></thead>
            <tbody id="high-risk-tbody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
  // LocalStorage helpers
  function get(key) { return JSON.parse(localStorage.getItem(key)) || []; }
  function set(key, value) { localStorage.setItem(key, JSON.stringify(value)); }

  // LIVE SYNC SYSTEM
  const SYNC_URL = 'https://anthonyshishokitop-stack.github.io/RBE226/data.json';
  let eq = [], up = [], mt = [], delaysData = [], calendar = null, charts = {};
  let syncInterval, lastSyncTime = 0, syncStatus = 'connecting';
  const SYNC_INTERVAL = 3000; // 3 seconds

  function updateLiveIndicator() {
    const indicator = document.getElementById('live-indicator');
    const text = document.getElementById('live-text');
    const now = Date.now();
    const timeSince = ((now - lastSyncTime) / 1000).toFixed(1);
    
    if (syncStatus === 'connecting') {
      indicator.className = 'live-indicator connecting';
      text.textContent = 'Connecting...';
    } else if (syncStatus === 'syncing') {
      indicator.className = 'live-indicator syncing';
      text.textContent = 'Syncing...';
    } else if (syncStatus === 'live' && timeSince < 5) {
      indicator.className = 'live-indicator live';
      text.textContent = `LIVE ‚Ä¢ ${timeSince}s`;
    } else {
      indicator.className = 'live-indicator';
      text.textContent = `Last sync: ${timeSince}s ago`;
    }
  }

  async function fetchRemoteData() {
    try {
      syncStatus = 'syncing';
      updateLiveIndicator();
      
      const response = await fetch(SYNC_URL + `?t=${Date.now()}`, { 
        cache: 'no-cache',
        headers: { 'Cache-Control': 'no-cache' }
      });
      
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const remoteData = await response.json();
      let dataChanged = false;

      if (JSON.stringify(remoteData.equipment) !== JSON.stringify(eq)) {
        eq = [...remoteData.equipment];
        dataChanged = true;
      }
      if (JSON.stringify(remoteData.updates) !== JSON.stringify(up)) {
        up = [...remoteData.updates];
        dataChanged = true;
      }
      if (JSON.stringify(remoteData.maintenance) !== JSON.stringify(mt)) {
        mt = [...remoteData.maintenance];
        dataChanged = true;
      }
      if (JSON.stringify(remoteData.delays) !== JSON.stringify(delaysData)) {
        delaysData = [...remoteData.delays];
        dataChanged = true;
      }

      if (dataChanged) {
        set('equipment', eq);
        set('updates', up);
        set('maintenance', mt);
        set('delays', delaysData);
        
        fillDatalist();
        populateDashboard();
        populateLogTable();
        populateSummaryTable();
        populateEquipmentTable();
        populateMaintTable();
        if (calendar) initCalendar();
      }

      lastSyncTime = Date.now();
      syncStatus = 'live';
    } catch (error) {
      console.warn('Sync failed:', error);
      syncStatus = 'connecting';
      // Fallback to local
      eq = get('equipment');
      up = get('updates');
      mt = get('maintenance');
      delaysData = get('delays');
    } finally {
      updateLiveIndicator();
    }
  }

  async function saveRemoteData() {
    try {
      const dataToSave = {
        equipment: eq,
        updates: up,
        maintenance: mt,
        delays: delaysData,
        timestamp: new Date().toISOString()
      };

      // For GitHub Pages, POST not supported, so console for demo
      console.log('Saving to remote:', dataToSave);
      // If backend available, use fetch POST
    } catch (error) {
      console.error('Save failed:', error);
    }
  }

  function startLiveSync() {
    fetchRemoteData();
    syncInterval = setInterval(fetchRemoteData, SYNC_INTERVAL);
    
    let saveTimeout;
    [eq, up, mt, delaysData].forEach(array => {
      const originalPush = array.push;
      array.push = function(...items) {
        const result = originalPush.apply(this, items);
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveRemoteData, 2000);
        return result;
      };
      const originalSplice = array.splice;
      array.splice = function(...args) {
        const result = originalSplice.apply(this, args);
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveRemoteData, 2000);
        return result;
      };
    });
  }

  // ==== THE FULL ORIGINAL SCRIPT ====
  let calendar = null;
  const shafts = [
    '0 Shaft', '1 Shaft', '2 Shaft', '3 Shaft', '4 Shaft', '5 Shaft', '6 Shaft', '7 Shaft',
    '7A Shaft', '8 Shaft', '9 Shaft', '10 Shaft', '10D', '11 Shaft', '11C Shaft', '11D',
    '12 Shaft', '12 North Shaft', '12S', '14 Shaft', '14D', '16 Shaft', '17 Shaft',
    '20 Shaft', 'CLAPHAM', 'DRIKOP', 'E&F Shaft', 'NORTH SHAFT', 'SOUTH SHAFT',
    'STYLDRIFT', 'Winnaarshoek', 'Forest Hill', 'Offset Underground',
    'UG2 Main Decline', 'Merensky Main Decline', 'UG2 North Decline',
    '367-KT (Kalkfontein)', '368-KT (Buffelshoek)', '370-KT (Richmond)',
    '372-KT (Dwarsrivier)', '373-KT (De Grooteboom)', '374-KT (Tweefontein)',
    'Leeuwkop Shaft'
  ];

  function toggleTheme() {
    const cur = document.body.getAttribute('data-theme');
    const newTheme = cur === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    document.getElementById('theme-toggle').textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  }

  function calculateNextDue(lastDone, interval) {
    if (!lastDone) return '';
    const d = new Date(lastDone);
    if (interval === 'weekly') d.setDate(d.getDate() + 7);
    else if (interval === 'monthly') d.setMonth(d.getMonth() + 1);
    else if (interval === 'quarterly') d.setMonth(d.getMonth() + 3);
    return d.toISOString().slice(0,10);
  }

  function calculateDaysLeft(lastDone, interval) {
    if (!lastDone) return NaN;
    const next = new Date(calculateNextDue(lastDone, interval));
    const today = new Date(); today.setHours(0,0,0,0);
    next.setHours(0,0,0,0);
    return Math.ceil((next - today) / 86400000);
  }

  function show(section) {
    document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
    document.getElementById(section).classList.remove('hidden');
    document.querySelectorAll('#sidebar-menu li').forEach(l => l.classList.remove('active'));
    document.querySelector(`#sidebar-menu li[data-section="${section}"]`).classList.add('active');

    if (section === 'calendar') setTimeout(initCalendar, 100);
    if (section === 'maintenance-schedule') populateMaintTable();
    if (section === 'operations-report') populateOperationsReport();
  }

  function initCalendar() {
    const el = document.getElementById('calendar-div');
    if (!el) return;
    if (calendar) calendar.destroy();
    const events = mt.map(m => ({
      title: `${m.equipment} - ${m.task}`,
      start: calculateNextDue(m.lastDone, m.interval),
      backgroundColor: '#3498db', borderColor: '#2980b9', textColor: '#fff'
    }));
    calendar = new FullCalendar.Calendar(el, {
      initialView: 'dayGridMonth', height: 'auto',
      headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
      events, eventDisplay: 'block', dayMaxEvents: true, contentHeight: 'auto', stickyHeaderDates: true
    });
    calendar.render();
  }

  function markDone(index) {
    mt[index].lastDone = new Date().toISOString().slice(0,10);
    set('maintenance', mt);
    populateMaintTable();
    populateDashboard();
  }

  function deleteMaint(index) {
    if (confirm('Delete this task?')) {
      mt.splice(index, 1);
      set('maintenance', mt);
      populateMaintTable();
      populateDashboard();
    }
  }

  function openEditModal(index) {
    const m = mt[index];
    document.getElementById('edit-index').value = index;
    document.getElementById('edit-equipment').value = m.equipment;
    document.getElementById('edit-task').value = m.task;
    document.getElementById('edit-interval').value = m.interval;
    document.getElementById('edit-last').value = m.lastDone;
    document.getElementById('edit-modal').classList.add('active');
  }

  function closeEditModal() {
    document.getElementById('edit-modal').classList.remove('active');
  }

  function closeAddMaintModal() {
    document.getElementById('add-maint-modal').classList.remove('active');
  }

  document.getElementById('edit-maint-form').addEventListener('submit', e => {
    e.preventDefault();
    const index = parseInt(document.getElementById('edit-index').value);
    mt[index] = {
      equipment: e.target[1].value,
      task: e.target[2].value,
      interval: e.target[3].value,
      lastDone: e.target[4].value
    };
    set('maintenance', mt);
    closeEditModal();
    populateMaintTable();
    populateDashboard();
  });

  function populateMaintTable() {
    const tbody = document.querySelector('#maint-table tbody');
    tbody.innerHTML = mt.map((m, i) => {
      const days = calculateDaysLeft(m.lastDone, m.interval);
      const disp = isNaN(days) ? '-' : (days >= 0 ? days : Math.abs(days) + ' overdue');
      const color = days > 3 ? '' : (days > 0 ? 'orange' : 'red');
      return `<tr>
        <td>${m.equipment}</td><td>${m.task}</td><td>${m.interval}</td><td>${m.lastDone}</td>
        <td>${calculateNextDue(m.lastDone, m.interval)}</td><td style="color:var(--${color});">${disp}</td>
        <td class="maint-actions">
          <button class="done-btn" onclick="markDone(${i})">Done</button>
          <button class="edit-btn" onclick="openEditModal(${i})">Edit</button>
          <button class="delete-btn" onclick="deleteMaint(${i})">Delete</button>
        </td>
      </tr>`;
    }).join('');
  }

  // Form handlers
  document.getElementById('add-eq-form').addEventListener('submit', e => {
    e.preventDefault();
    eq.push({
      Shaft: e.target[0].value,
      Level: e.target[1].value,
      'Loco Size': e.target[2].value,
      'Loco Number': e.target[3].value,
      SECTION: e.target[4].value
    });
    set('equipment', eq);
    fillDatalist();
    populateDashboard();
    populateEquipmentTable();
    e.target.reset();
  });

  document.getElementById('add-status-form').addEventListener('submit', e => {
    e.preventDefault();
    up.push({
      Date: e.target[0].value,
      Time: e.target[1].value,
      'Equipment ID': e.target[2].value,
      Status: e.target[3].value,
      Shift: e.target[4].value,
      'Reason/Fault': e.target[5].value,
      'Downtime Hours': parseFloat(e.target[6].value) || 0,
      'Is Failure?': parseInt(e.target[7].value)
    });
    set('updates', up);
    populateDashboard();
    populateLogTable();
    populateSummaryTable();
    e.target.reset();
  });

  document.getElementById('add-maint-form').addEventListener('submit', e => {
    e.preventDefault();
    mt.push({
      equipment: e.target[0].value,
      task: e.target[1].value,
      interval: e.target[2].value,
      lastDone: e.target[3].value
    });
    set('maintenance', mt);
    closeAddMaintModal();
    populateMaintTable();
    populateDashboard();
    e.target.reset();
  });

  // Navigation
  document.querySelectorAll('#sidebar-menu li').forEach(li => {
    li.addEventListener('click', () => show(li.dataset.section));
  });

  // Search form
  document.getElementById('search-form').addEventListener('submit', e => {
    e.preventDefault();
    const loco = document.getElementById('s-loco').value;
    const date = document.getElementById('s-date').value;
    const showAll = document.getElementById('show-all-history').checked;
    if (!loco) return alert('Enter Equipment ID');
    const equipment = eq.find(e => e['Loco Number'] === loco);
    if (!equipment) return alert('Equipment not found');
    const resultsDiv = document.getElementById('search-results');
    const header = `<div style="background:rgba(13,71,161,.15);padding:1rem;border-radius:12px;margin-bottom:1rem;">
        <strong>Equipment:</strong> ${equipment['Loco Number']} ‚Äì ${equipment.Shaft}<br>
        <strong>Level:</strong> ${equipment.Level} | 
        <strong>Size:</strong> ${equipment['Loco Size']} | 
        <strong>Section:</strong> ${equipment.SECTION}
      </div>`;

    let updates = up.filter(u => u['Equipment ID'] === loco);
    if (date && !showAll) updates = updates.filter(u => u.Date === date);
    updates.sort((a,b) => new Date(b.Date+' '+b.Time) - new Date(a.Date+' '+a.Time));

    const updatesHTML = updates.length ? updates.map(u => `
      <div style="padding:12px;border-bottom:1px solid rgba(255,255,255,.12);">
        <strong>${u.Date} ${u.Time}</strong> ‚Äì 
        <span style="color:${u.Status==='Fixed'?'#2ecc71':'#e74c3c'}">${u.Status}</span>:
        ${u['Reason/Fault']} 
        ${u['Downtime Hours']?`<em>(${u['Downtime Hours']} h)</em>`:''}
        ${u['Is Failure?']===1?'<span class="risk-badge risk-high" style="margin-left:8px;">FAILURE</span>':''}
      </div>`).join('') : '<p style="color:#f39c12;font-style:italic;">No updates yet.</p>';

    resultsDiv.innerHTML = header + updatesHTML;
  });

  // Initial load
  window.addEventListener('load', () => {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.body.setAttribute('data-theme', savedTheme);
    document.getElementById('theme-toggle').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    
    document.getElementById('m-last').value = new Date().toISOString().slice(0,10);
    document.getElementById('u-date').value = new Date().toISOString().slice(0,10);
    document.getElementById('s-date').value = new Date().toISOString().slice(0,10);

    startLiveSync();
    show('dashboard');
  });
</script>
</body>
</html>